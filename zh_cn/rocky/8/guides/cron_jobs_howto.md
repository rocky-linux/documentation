# 在 Rocky Linux 中使用 cron 和 crontab 自动化进程

## 准备工作

* 一台运行 Rocky Linux 的机器。
* 知道如何在命令行环境下使用您喜欢的编辑器修改配置文件（本文将使用 _vi_）。

## <a name="assumptions"></a>假定

* 您已了解 bash、python 或其他脚本/编程工具的基本知识，并期望自动运行脚本。
* 您已以 root 用户身份运行，或使用 `sudo -s` 切换到 root 用户。
**（您可以以自己的用户身份在自己的目录中运行某些脚本。在这种情况下，无需切换到 root。）**

# 简介

Linux提供了 _cron_ 系统，一个基于时间的作业调度程序，用于自动化进程。它很简单，也很强大。想让脚本或程序每天下午 5 点运行吗？设置 cron 即可。

_crontab_ 本质上是一个列表，用户可以在其中添加自己的自动化任务和作业，并且有许多可以进一步简化操作的选项。本文将探讨其中的一些选项。本文对有一定经验的用户而言是一个很好的温习，对新用户而言将系统学习 cron。

## <a name="starting-easy"></a>轻松入门 —— cron 点目录

包括 Rock Linux 在内的许多 Linux 发行版都内置了 cron 点文件，这些文件有助于快速配置自动化进程。它们显示为 cron 系统根据其命名约定调用的目录。

为了使某些文件在这些自动定义的时间内运行，您所需要做的就是将脚本文件复制到相关目录中，并确保其可执行文件。以下是目录及其运行时间：

* `/etc/cron.hourly/` - 放置在此处的脚本将在每天每小时的 1 分钟后运行。
* `/etc/cron.daily` - 放置在此处的脚本每天凌晨 4:02 运行。
* `/etc/cron.weekly` - 放置在此处的脚本将在每周的周日凌晨 4:22 运行。
* `/etc/cron.monthly` - 放置在此处的的脚本将在每月第一天的凌晨 4:42 运行。

因此，您只要让系统在这些预定时间之一自动运行脚本就可以了，这使自动化任务变得非常容易。

## 创建自定义 cron

当然，无论出于何种原因，自动化时间都不能很好地为您工作，那么您可以创建自定义时间。本示例中，假设您以 root 用户身份执行此操作。为此，[请参见假定](##-assumptions)，键入以下内容：

`crontab -e`

这将调出 root 用户的 crontab，就像它此时存在于您选择的编辑器中一样，可能如下所示。请继续阅读以下注释，因为它包含接下来将使用的每个字段的描述：

```
# 编辑此文件以引入要由 cron 运行的任务。
# 
# 一行定义一个要运行的任务
# 在一行中用不同的字段指示何时运行该任务
# 以及为该任务运行的命令
# 
# 要定义时间，可以为
# 分钟（m）、小时（h）、月日（dom）、月（mon）和星期（dow）
# 提供具体值，或者在这些字段中使用“*”（表示“任何”）。
# 
# 注意，将根据 cron 的系统守护程序的时间和时区概念启动任务。
# 
# 作业的输出（包括错误）通过电子邮件发送给
# crontab 文件所属的用户（除非重定向）。
# cron
# 例如，每周一上午 5 点运行所有用户帐户的备份：
# 0 5 * * 1 tar -zcf /var/backups/home.tgz /home/
# 
# 有关更多信息，请参见 crontab（5）和 cron（8）的手册页
# 
# m h  dom mon dow   command
```

注意，这个特定的 crontab 文件内置了一些自己的文档。并非总是如此。在容器或极简操作系统上修改 crontab 时，crontab 将是一个空文件，除非已经在其中放置了条目。

假设有一个备份脚本，希望在晚上 10 点运行。crontab 使用 24 小时制，因此应该是 22:00。假设备份脚本名为“backup”，并且当前位于 _/usr/local/sbin_ 目录中。

注意：这个脚本也需要是可执行的（`chmod+x`），cron 才能运行它。要添加作业：

`crontab -e`

 “crontab”代表“cron table”，文件的格式实际上是松散的表布局。现在在 crontab 中，转到文件的底部并添加新条目。如果您使用 vi 作为默认的系统编辑器，那么可以通过以下键来完成：

`Shift : $`

现在，您位于文件的底部，插入一行并键入简短的注释以描述条目的内容。注释是通过在行首添加“＃”来完成的：

`# 每晚 10 点备份系统`

现在按回车键。您应该仍然处于插入模式，因此下一步是添加条目。如以上空注释的 crontab 所示，**m** 表示分钟，**h** 表示小时，**dom** 表示月日，**mon** 表示月，**dow** 表示星期。

要在每晚 10:00 运行备份脚本，条目如下所示：

`00  22  *  *  *   /usr/local/sbin/backup`

这表示在每月、每周和每日的晚上 10 点运行脚本。显然，这是一个非常简单的示例，当您需要详细说明时，情况可能会变得非常复杂。

### crontab 的 @ 选项

如本文档上面的[轻松入门](##-starting-easy)部分所述，cron 点目录中的脚本在特定的时间运行。@ 选项提供使用更自然的定时能力。@ 选项包括：

* `@hourly` 在每天每小时的 0 分钟后运行脚本。
* `@daily` 在每天午夜运行脚本。
* `@weekly` 在每周的周日午夜运行脚本。
* `@monthly` 在每个月的第一天午夜运行脚本。
* `@yearly` 在每年 1 月 1 日午夜运行脚本。
* `@reboot` 仅在系统启动时运行脚本。

对于备份脚本示例，如果使用 @daily 选项在午夜运行备份脚本，则该条目将如下所示：

`@daily  /usr/local/sbin/backup`

### 复杂选项

到目前为止，所讨论的内容都是非常简单的选项，但是更复杂的定时任务又该如何完成呢？假设要在一天中每 10 分钟运行一次备份脚本（可能不切实际，但是，仅是一个示例！）。为此，将编写以下内容：

`*/10  *   *   *   *   /usr/local/sbin/backup`

如果您只想在星期一、星期三和星期五的每 10 分钟运行一次备份呢？:

`*/10  *   *   *   1,3,5   /usr/local/sbin/backup`

除了星期六和星期日，每天每 10 分钟备份一次又如何？

`*/10  *   *   *   1-5   /usr/local/sbin/backup`

在表中，逗号用于指定字段中的单个条目，而破折号用于指定字段中的值范围。它可以在任何字段中使用，也可以同时在多个字段中使用。如您所见，情况会变得相当复杂。

在确定何时运行脚本时，您需要花费时间并进行规划，尤其是在条件复杂的情况下。

# 总结

对于 Rocky Linux 桌面用户或系统管理员而言，cron/crontab 系统是一个非常强大的工具。它可以让您自动执行任务和脚本，这样您就不必记住手动运行它们。

虽然基础知识很简单，但实际任务可能很复杂。有关 crontab 的更多信息，请访问 [crontab 手册页](https://man7.org/linux/man-pages/man5/crontab.5.html)。您还可以简单地在网上搜索“crontab”，它将为您提供大量搜索结果，帮助您微调 crontab 表达式。
