---
title: 4 Налаштування брандмауера
author: Steven Spencer
contributors: Ezequiel Bruni
tested with: 8.5, 8.6, 9.0
tags:
  - lxd
  - enterprise
  - lxd security
---

# Розділ 4: Налаштування брандмауера

У цьому розділі вам потрібно мати права root або вміти викорисовувати `sudo`, щоб стати root.

Як і будь-який сервер, вам потрібно переконатися, що він захищений від зовнішнього світу та вашої локальної мережі. У той час як наш приклад сервера має лише інтерфейс локальної мережі, цілком можливо мати два інтерфейси, по одному для вашої мережі LAN та WAN. Хоча ми розглядаємо правила `iptables` у цій процедурі, ми **настійно** рекомендуємо замість цього використовувати процедуру `firewalld` (див. примітку нижче).

## Налаштування брандмауера - iptables

!!! примітка "Примітка щодо Rocky Linux 9.0"

    Починаючи з Rocky Linux 9.0, `iptables` та всі пов’язані з ним утиліти офіційно застаріли. Це означає, що в майбутніх версіях ОС, можливо, вже в 9.1, вони взагалі зникнуть. З цієї причини вам слід перейти до процедури `firewalld`, наведеної нижче, перш ніж продовжити.
    
    Насправді було б гарною ідеєю використовувати `firewalld` і для Rocky Linux 8.6, але ми *пропонуємо* вам можливість використовувати `iptables`, якщо ви цього дійсно хочете.

Перш ніж продовжити, вам потрібно встановити брандмауер на вашому сервері. У цьому прикладі використовується _iptables_ і [ця процедура](../../guides/security/enabling_iptables_firewall.md) для вимкнення _брандмауера_. Якщо ви віддаєте перевагу використанню _firewalld_, просто замініть правила _firewalld_, дотримуючись інструкцій, наведених у цьому розділі.

Створіть свій сценарій firewall.conf:

```
vi /etc/firewall.conf
```

Ми припускаємо, що сервер LXD у мережі LAN 192.168.1.0/24 нижче. Зауважте також, що ми приймаємо весь трафік із нашого мостового інтерфейсу. Це важливо, якщо ви хочете, щоб ваші контейнери отримували IP-адреси з мосту.

Цей сценарій брандмауера не робить інших припущень щодо необхідних мережевих служб. Існує правило SSH, яке дозволяє IP-адресам нашої локальної мережі передавати SSH на сервер. Ви можете дуже легко мати багато інших правил, які потрібні тут, залежно від вашого середовища. Пізніше ми додамо правило для двонаправленого трафіку між нашим робочим сервером і сервером snapshot.

```
#!/bin/sh
#
#IPTABLES=/usr/sbin/iptables

#  Unless specified, the defaults for OUTPUT is ACCEPT
#    The default for FORWARD and INPUT is DROP
#
echo "   clearing any existing rules and setting default policy.."
iptables -F INPUT
iptables -P INPUT DROP
iptables -A INPUT -i lxdbr0 -j ACCEPT
iptables -A INPUT -p tcp -m tcp -s 192.168.1.0/24 --dport 22 -j ACCEPT
iptables -A INPUT -i lo -j ACCEPT
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A INPUT -p tcp -j REJECT --reject-with tcp-reset
iptables -A INPUT -p udp -j REJECT --reject-with icmp-port-unreachable

/usr/sbin/service iptables save
```

## Налаштування брандмауера - firewalld

Для правил _firewalld_ нам потрібно використовувати [цю базову процедуру](../../guides/security/firewalld.md) або бути знайомим з цими поняттями. Наші припущення такі ж, як і для правил _iptables_ вище: мережа LAN 192.168.1.0/24 і міст під назвою lxdbr0. Щоб було зрозуміло, у вас може бути кілька інтерфейсів на вашому сервері LXD, причому один, можливо, також звернений до вашої WAN. Також ми збираємося створити зону для мостової та локальної мереж. Але це зони для розуміння, оскільки інші назви насправді не застосовуються. Нижче припускається, що ви вже знаєте основи _брандмауера_.

```
firewall-cmd --new-zone=bridge --permanent
```

Вам потрібно перезавантажити брандмауер після додавання зони:

```
firewall-cmd --reload
```

Ми хочемо дозволити весь трафік з мосту, тож давайте просто додамо інтерфейс, а потім змінимо ціль із «за замовчуванням» на «ПРИЙНЯТИ», і ми готові:

!!! важливо

    Зміна цільової зони брандмауера *має* здійснюватися за допомогою параметра --permanent, тому ми можемо також просто ввести цей прапорець в інших наших командах і відмовитися від параметра --runtime-to-permanent.

!!! Примітка

    Якщо вам потрібно створити зону, у якій ви бажаєте дозволити повний доступ до інтерфейсу чи джерела, але не хочете вказувати жодних протоколів чи служб, тоді ви *потрібно* змінити ціль із «за замовчуванням» на ПРИЙНЯТИ. Те саме стосується DROP і REJECT для певного IP-блоку, для якого у вас є спеціальні зони. Щоб було зрозуміло, зона «drop» подбає про це за вас, доки ви не використовуєте спеціальну зону.

```
firewall-cmd --zone=bridge --add-interface=lxdbr0 --permanent
firewall-cmd --zone=bridge --set-target=ACCEPT --permanent
```
Якщо припустити, що помилок немає і все працює, просто перезавантажте:

```
firewall-cmd --reload
```
Якщо ви зараз перерахуєте свої правила за допомогою `firewall-cmd --zone=bridge --list-all`, ви побачите щось на зразок такого:

```
bridge (active)
  target: ACCEPT
  icmp-block-inversion: no
  interfaces: lxdbr0
  sources:
  services:
  ports:
  protocols:
  forward: no
  masquerade: no
  forward-ports:
  source-ports:
  icmp-blocks:
  rich rules:
```
Зверніть увагу на правила _iptables_, що ми також хочемо дозволити наш локальний інтерфейс. Знову ж таки, мені не подобаються включені зони для цього, тому створіть нову зону та використовуйте вихідний діапазон IP для локального інтерфейсу, щоб переконатися, що у вас є доступ:

```
firewall-cmd --new-zone=local --permanent
firewall-cmd --reload
```
Потім нам просто потрібно додати вихідні IP-адреси для локального інтерфейсу, змінити ціль на «ACCEPT», і ми також закінчили з цим:

```
firewall-cmd --zone=local --add-source=127.0.0.1/8 --permanent
firewall-cmd --zone=local --set-target=ACCEPT --permanent
firewall-cmd --reload
```
Давайте перерахуємо «локальну» зону, щоб переконатися, що ваші правила є там, за допомогою `firewall-cmd --zone=local --list all`, яка має показати вам щось на зразок цього:

```
local (active)
  target: ACCEPT
  icmp-block-inversion: no
  interfaces:
  sources: 127.0.0.1/8
  services:
  ports:
  protocols:
  forward: no
  masquerade: no
  forward-ports:
  source-ports:
  icmp-blocks:
  rich rules:
```

Далі ми хочемо дозволити SSH з нашої надійної мережі. Тут ми будемо використовувати вихідні IP-адреси, як і в нашому прикладі _iptables_, і вбудовану «довірену» зону. Ціль для цієї зони вже "ПРИЙНЯТИ" за замовчуванням.

```
firewall-cmd --zone=trusted --add-source=192.168.1.0/24
```
Потім додайте послугу в зону:

```
firewall-cmd --zone=trusted --add-service=ssh
```
І якщо все працює, перемістіть свої правила на постійні та перезавантажте правила:

```
firewall-cmd --runtime-to-permanent
firewall-cmd --reload
```
Перелік вашої «довіреної» зони тепер має показати вам щось на зразок цього:

```
trusted (active)
  target: ACCEPT
  icmp-block-inversion: no
  interfaces:
  sources: 192.168.1.0/24
  services: ssh
  ports:
  protocols:
  forward: no
  masquerade: no
  forward-ports:
  source-ports:
  icmp-blocks:
  rich rules:
```

За замовчуванням увімкнено «публічну» зону та дозволено SSH. Ми цього не хочемо. Переконайтеся, що ваші зони правильні, а доступ до сервера здійснюється через одну з IP-адрес локальної мережі (у випадку нашого прикладу) і дозволено через SSH. Ви можете заблокувати себе на сервері, якщо не підтвердите це, перш ніж продовжити. Переконавшись, що у вас є доступ із правильного інтерфейсу, видаліть SSH із загальнодоступної зони:

```
firewall-cmd --zone=public --remove-service=ssh
```

Перевірте доступ і переконайтеся, що ви не заблоковані. Якщо ні, перенесіть свої правила на постійні, перезавантажте та винесіть зону "публічно", щоб переконатися, що SSH видалено:

```
firewall-cmd --runtime-to-permanent
firewall-cmd --reload
firewall-cmd --zone=public --list-all
```

На вашому сервері можуть бути інші інтерфейси. Ви можете використовувати вбудовані зони, де це доречно, але якщо вам не подобаються назви (вони не здаються логічними тощо), ви можете точно додати зони. Просто пам’ятайте, що якщо у вас немає служб або протоколів, які вам потрібно дозволити або відхилити спеціально, вам потрібно буде змінити цільову зону. Якщо використання інтерфейсів працює, як ми зробили з мостом, ви можете це зробити. Якщо вам потрібен детальніший доступ до служб, натомість використовуйте вихідні IP-адреси.
