---
title: 6 Профілі
author: Steven Spencer
contributors: Ezequiel Bruni
tested with: 8.5, 8.6, 9.0
tags:
  - lxd
  - enterprise
  - lxd профілі
---

# Розділ 6: Профілі

У цій главі вам потрібно буде виконувати команди як непривілейований користувач ("lxdadmin", якщо ви слідкували за цим із самого початку цієї книги).

Під час встановлення LXD ви отримуєте профіль за замовчуванням, і цей профіль не можна видалити чи змінити. Тим не менш, ви можете використовувати профіль за замовчуванням для створення нових профілів для використання з вашими контейнерами.

Якщо ви подивитеся на наш список контейнерів, ви помітите, що IP-адреса в кожному випадку призначається через мостовий інтерфейс. У виробничому середовищі ви можете використовувати щось інше. Це може бути адреса, призначена DHCP з вашого інтерфейсу LAN, або навіть статична адреса з вашої WAN.

Якщо ви налаштуєте свій сервер LXD із двома інтерфейсами та призначите кожному IP-адресу в глобальній і локальній мережах, тоді можна призначити IP-адреси контейнерів на основі того, до якого інтерфейсу має бути спрямований контейнер.

Починаючи з версії 9.0 Rocky Linux (і фактично будь-якої помилки для копії помилок Red Hat Enterprise Linux) метод призначення IP-адрес статично або динамічно за допомогою наведених нижче профілів не працює.

Є способи обійти це, але це дратує. Схоже, це якось пов’язано зі змінами, внесеними до Network Manager, які впливають на macvlan. macvlan дозволяє створювати кілька інтерфейсів з різними адресами рівня 2.

Наразі майте на увазі, що те, що ми збираємося запропонувати далі, має недоліки під час вибору зображень контейнерів на основі RHEL.

## Створення та призначення профілю macvlan

Щоб створити наш профіль macvlan, просто скористайтеся цією командою:

```
lxc profile create macvlan
```

Майте на увазі, що якщо ми працювали на багатоінтерфейсній машині й хотіли мати більше ніж один шаблон macvlan, залежно від того, яку мережу ми хотіли охопити, ми могли б використовувати «lanmacvlan» або «wanmacvlan» або будь-яке інше ім’я, яке ми хотіли б використовувати для ідентифікації профілю. Іншими словами, використання «macvlan» у нашому операторі створення профілю повністю залежить від вас.

Тепер ми хочемо змінити інтерфейс macvlan, але перед тим, як це зробити, нам потрібно знати, що таке батьківський інтерфейс для нашого сервера LXD. Це буде інтерфейс, якому призначено IP-адресу локальної мережі (у цьому випадку). Щоб визначити, який це інтерфейс, використовуйте:

```
ip addr
```

А потім знайдіть інтерфейс із призначенням LAN IP у мережі 192.168.1.0/24:

```
2: enp3s0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 40:16:7e:a9:94:85 brd ff:ff:ff:ff:ff:ff
    inet 192.168.1.106/24 brd 192.168.1.255 scope global dynamic noprefixroute enp3s0
       valid_lft 4040sec preferred_lft 4040sec
    inet6 fe80::a308:acfb:fcb3:878f/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
```

Отже, в цьому випадку інтерфейс буде "enp3s0".

Тепер давайте змінимо профіль:

```
lxc profile device add macvlan eth0 nic nictype=macvlan parent=enp3s0
```

Ця команда додає всі необхідні параметри до профілю macvlan, щоб його можна було використовувати.

Щоб побачити, що створила ця команда, скористайтеся командою:

```
lxc profile show macvlan
```

Що дасть вам результат, подібний до цього:


```
config: {}
description: ""
devices:
  eth0:
    nictype: macvlan
    parent: enp3s0 
    type: nic
name: macvlan
used_by: []
```

Очевидно, що ви можете використовувати профілі для багатьох інших речей, але призначення статичної IP-адреси контейнеру або використання власного DHCP-сервера як джерела для адреси є дуже поширеними потребами.

Щоб призначити профіль macvlan для rockylinux-test-8, нам потрібно зробити наступне:

```
lxc profile assign rockylinux-test-8 default,macvlan
```

Зробимо те саме для rockylinux-test-9:

```
lxc profile assign rockylinux-test-9 default,macvlan
```

Це просто означає, що нам потрібен профіль за замовчуванням, а потім ми також хочемо застосувати профіль macvlan.

## Rocky Linux macvlan

У дистрибутивах і клонах RHEL Network Manager постійно змінювався. На початку Rocky Linux 8 профіль macvlan був зламаний.

Майте на увазі, що нічого з цього не має нічого спільного з Rocky Linux, а лише з реалізацією пакета вище.

Простіше кажучи, якщо ви хочете запустити контейнери Rocky Linux і використовувати macvlan для призначення IP-адреси з вашої мережі LAN або WAN, тоді процес відрізняється залежно від того, яку версію ОС контейнера ви використовуєте (8.6 або 9.0).

### Rocky Linux 9.0 macvlan – виправлення DHCP

По-перше, давайте проілюструємо, що відбувається, коли ми зупиняємо та перезапускаємо два контейнери після призначення профілю macvlan.

Однак призначення профілю не змінює конфігурацію за замовчуванням, для якої за замовчуванням встановлено DHCP.

Щоб перевірити це, просто виконайте такі дії:

```
lxc restart rocky-test-8
lxc restart rocky-test-9
```

Тепер знову перерахуйте свої контейнери та зауважте, що rockylinux-test-9 більше не має IP-адреси:

```
lxc list
```

```
+-------------------+---------+----------------------+------+-----------+-----------+
|       NAME        |  STATE  |         IPV4         | IPV6 |   TYPE    | SNAPSHOTS |
+-------------------+---------+----------------------+------+-----------+-----------+
| rockylinux-test-8 | RUNNING | 192.168.1.114 (eth0) |      | CONTAINER | 0         |
+-------------------+---------+----------------------+------+-----------+-----------+
| rockylinux-test-9 | RUNNING |                      |      | CONTAINER | 0         |
+-------------------+---------+----------------------+------+-----------+-----------+
| ubuntu-test       | RUNNING | 10.146.84.181 (eth0) |      | CONTAINER | 0         |
+-------------------+---------+----------------------+------+-----------+-----------+

```
Як бачите, наш контейнер Rocky Linux 8.6 отримав IP-адресу від інтерфейсу LAN, тоді як контейнер Rocky Linux 9.0 ні.

Щоб детальніше продемонструвати проблему, нам потрібно виконати `dhclient` у контейнері Rocky Linux 9.0. Це покаже нам, що профіль macvlan *є* фактично застосованим:

```
lxc exec rockylinux-test-9 dhclient
```

Новий список із використанням `lxc list` тепер показує таке:

```
+-------------------+---------+----------------------+------+-----------+-----------+
|       NAME        |  STATE  |         IPV4         | IPV6 |   TYPE    | SNAPSHOTS |
+-------------------+---------+----------------------+------+-----------+-----------+
| rockylinux-test-8 | RUNNING | 192.168.1.114 (eth0) |      | CONTAINER | 0         |
+-------------------+---------+----------------------+------+-----------+-----------+
| rockylinux-test-9 | RUNNING | 192.168.1.113 (eth0) |      | CONTAINER | 0         |
+-------------------+---------+----------------------+------+-----------+-----------+
| ubuntu-test       | RUNNING | 10.146.84.181 (eth0) |      | CONTAINER | 0         |
+-------------------+---------+----------------------+------+-----------+-----------+
```

Це мало статися з простою зупинкою та запуском контейнера, але цього не відбувається. Якщо припустити, що ми хочемо щоразу використовувати IP-адресу, призначену DHCP, ми можемо виправити це за допомогою простого запису в crontab. Для цього нам потрібно отримати доступ оболонки до контейнера, ввівши:

```
lxc exec rockylinux-test-9 bash
```

Далі визначимо повний шлях до `dhclient`. Для цього, оскільки це було створено на мінімальному образі, вам потрібно буде спочатку встановити `which`:

```
dnf install which
```

потім запустіть:

```
which dhclient
```

який має повернути:

```
/usr/sbin/dhclient
```

Далі змінимо crontab користувача root:

```
crontab -e
```

І додайте цей рядок:

```
@reboot    /usr/sbin/dhclient
```

Команда crontab, введена вище, використовує _vi_, тому, щоб зберегти зміни та вийти, просто скористайтеся:

```
SHIFT:wq!
```

Тепер вийдіть із контейнера та перезапустіть rockylinux-test-9:

```
lxc restart rockylinux-test-9
```

Новий список покаже, що контейнеру було призначено адресу DHCP:

```
+-------------------+---------+----------------------+------+-----------+-----------+
|       NAME        |  STATE  |         IPV4         | IPV6 |   TYPE    | SNAPSHOTS |
+-------------------+---------+----------------------+------+-----------+-----------+
| rockylinux-test-8 | RUNNING | 192.168.1.114 (eth0) |      | CONTAINER | 0         |
+-------------------+---------+----------------------+------+-----------+-----------+
| rockylinux-test-9 | RUNNING | 192.168.1.113 (eth0) |      | CONTAINER | 0         |
+-------------------+---------+----------------------+------+-----------+-----------+
| ubuntu-test       | RUNNING | 10.146.84.181 (eth0) |      | CONTAINER | 0         |
+-------------------+---------+----------------------+------+-----------+-----------+

```

### Rocky Linux 9.0 macvlan – виправлення статичної IP-адреси

Для статичного призначення IP-адреси все стає ще заплутанішим. Оскільки `network-scripts` тепер не підтримується в Rocky Linux 9.0, єдиний спосіб зробити це — через статичне призначення, і через те, як контейнери використовують мережу, ви не зможете встановити маршрут за допомогою звичайного оператора `ip route`. Проблема полягає в тому, що інтерфейсом, призначеним під час застосування профілю macvlan (у цьому випадку eth0), неможливо керувати. Виправлення полягає в тому, щоб перейменувати мережевий інтерфейс контейнера після перезавантаження, а потім призначити статичну IP-адресу. Все це можна записати в скрипт і зробити (знову) за допомогою root-файлу crontab. Усе це робиться за допомогою команди `ip`.

Для цього нам потрібно знову отримати доступ оболонки до контейнера:

```
lxc exec rockylinux-test-9 bash
```

Далі ми створимо сценарій bash у `/usr/local/sbin` під назвою «static»:

```
vi /usr/local/sbin/static
```

Вміст цього сценарію простий:

```
#!/usr/bin/env bash

/usr/sbin/ip link set dev eth0 name net0
/usr/sbin/ip addr add 192.168.1.151/24 dev net0
/usr/sbin/ip link set dev net0 up
/usr/sbin/ip route add default via 192.168.1.1
```

Отже, що ми тут робимо? Спочатку ми перейменуємо eth0 на нове ім’я, яким ми зможемо керувати. Тут ми вибрали "net0". По-друге, ми призначаємо новий статичний IP, який ми виділили для нашого контейнера. У цьому випадку 192.168.1.151. Тепер ми відкриваємо новий інтерфейс "net0". Нарешті, нам потрібно додати маршрут за замовчуванням для нашого інтерфейсу.


Зробіть наш сценарій виконуваним за допомогою:

```
chmod +x /usr/local/sbin/static
```

Далі ми додаємо це до root-файлу crontab для контейнера, використовуючи час @reboot:

```
@reboot     /usr/local/sbin/static
```

Нарешті, вийдіть з контейнера та перезапустіть його:

```
lxc restart rockylinux-test-9
```

Зачекайте кілька секунд і знову виведіть список контейнерів:

```
lxc list
```

Що має відобразити наступне:

```
+-------------------+---------+----------------------+------+-----------+-----------+
|       NAME        |  STATE  |         IPV4         | IPV6 |   TYPE    | SNAPSHOTS |
+-------------------+---------+----------------------+------+-----------+-----------+
| rockylinux-test-8 | RUNNING | 192.168.1.114 (eth0) |      | CONTAINER | 0         |
+-------------------+---------+----------------------+------+-----------+-----------+
| rockylinux-test-9 | RUNNING | 192.168.1.151 (eth0) |      | CONTAINER | 0         |
+-------------------+---------+----------------------+------+-----------+-----------+
| ubuntu-test       | RUNNING | 10.146.84.181 (eth0) |      | CONTAINER | 0         |
+-------------------+---------+----------------------+------+-----------+-----------+
```

## Ubuntu macvlan

На щастя, у реалізації Менеджера мережі в Ubuntu стек macvlan НЕ зламаний, тому розгорнути його набагато легше!

По-перше, як і з нашим контейнером rockylinux-test-9, нам потрібно призначити шаблон нашому контейнеру:

```
lxc profile assign ubuntu-test default,macvlan
```

Це має бути все, що потрібно для отримання адреси, призначеної DHCP. Щоб дізнатися, зупиніть, а потім знову запустіть контейнер:

```
lxc restart ubuntu-test
```

Потім знову перерахуйте контейнери:

```
+-------------------+---------+----------------------+------+-----------+-----------+
|       NAME        |  STATE  |         IPV4         | IPV6 |   TYPE    | SNAPSHOTS |
+-------------------+---------+----------------------+------+-----------+-----------+
| rockylinux-test-8 | RUNNING | 192.168.1.114 (eth0) |      | CONTAINER | 0         |
+-------------------+---------+----------------------+------+-----------+-----------+
| rockylinux-test-9 | RUNNING | 192.168.1.151 (eth0) |      | CONTAINER | 0         |
+-------------------+---------+----------------------+------+-----------+-----------+
| ubuntu-test       | RUNNING | 192.168.1.132 (eth0) |      | CONTAINER | 0         |
+-------------------+---------+----------------------+------+-----------+-----------+
```

Успішно!

Налаштування статичної IP-адреси трохи відрізняється, але зовсім не складно. Нам потрібно змінити файл .yaml, пов’язаний із з’єднанням контейнера (/10-lxc.yaml). Для цього статичного IP ми будемо використовувати 192.168.1.201:

```
vi /etc/netplan/10-lxc.yaml
```

І змініть те, що там є, на таке:

```
network:
  version: 2
  ethernets:
    eth0:
      dhcp4: false
      addresses: [192.168.1.201/24]
      gateway4: 192.168.1.1
      nameservers:
        addresses: [8.8.8.8,8.8.4.4]
```

Збережіть зміни (`SHFT:wq!`) і вийдіть із контейнера.

Тепер перезапустіть контейнер:

```
lxc restart ubuntu-test
```

Коли ви знову перерахуєте свої контейнери, ви побачите нашу нову статичну IP-адресу:

```
+-------------------+---------+----------------------+------+-----------+-----------+
|       NAME        |  STATE  |         IPV4         | IPV6 |   TYPE    | SNAPSHOTS |
+-------------------+---------+----------------------+------+-----------+-----------+
| rockylinux-test-8 | RUNNING | 192.168.1.114 (eth0) |      | CONTAINER | 0         |
+-------------------+---------+----------------------+------+-----------+-----------+
| rockylinux-test-9 | RUNNING | 192.168.1.151 (eth0) |      | CONTAINER | 0         |
+-------------------+---------+----------------------+------+-----------+-----------+
| ubuntu-test       | RUNNING | 192.168.1.201 (eth0) |      | CONTAINER | 0         |
+-------------------+---------+----------------------+------+-----------+-----------+

```

Успішно!

У прикладах, використаних у цій главі, ми навмисно вибрали жорсткий контейнер для налаштування та два легких. Очевидно, що в списку зображень доступно багато інших версій Linux. Якщо у вас є улюблений, спробуйте встановити його, призначити шаблон macvlan і налаштувати IP-адреси.
