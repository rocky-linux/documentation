---
title: Звітування про процес Postfix
author: Steven Spencer
contributors: Ezequiel Bruni
tested_with: 8.5, 8.6, 9.0
tags:
  - email
  - звіти
  - інструменти
---

# Використання Postfix для звітування про процеси сервера

## Передумови

* Повний комфорт роботи з командного рядка на сервері Rocky Linux
* Знайомство з редактором на ваш вибір (у цьому документі використовується редактор _vi_, але ви можете замінити його улюбленим редактором)
* Розуміння DNS (системи доменних імен) та імен хостів
* Можливість призначати змінні в сценарії bash
* Знання того, що роблять команди _tail_, _more_, _grep_ і _date_

## Вступ

Багато адміністраторів серверів Rocky Linux пишуть сценарії для виконання певних завдань, таких як резервне копіювання або синхронізація файлів, і багато з цих сценаріїв створюють журнали, які містять корисну, а часом і дуже важливу інформацію. Однак мати лише журнали недостатньо. Якщо процес дає збій і реєструє цю помилку, але зайнятий адміністратор не переглядає журнал, тоді може бути катастрофа.

У цьому документі показано, як використовувати _postfix_ MTA (агент передачі пошти), щоб отримати дані журналу з певного процесу та надіслати їх вам електронною поштою. Він також торкається форматів дати в журналах і допомагає визначити, який формат використовувати в процедурі звітування.

Однак пам’ятайте, що це лише верхівка айсберга щодо того, що можна зробити за допомогою звітів через Postfix. Будь ласка, також зауважте, що обмежити запущені процеси лише тими, які вам постійно потрібні, завжди є хорошим заходом безпеки.

У цьому документі показано, як увімкнути Postfix лише для звітів, які вам потрібні, а потім знову вимкнути його.

## Визначення Postfix

Postfix — це серверний демон, який використовується для надсилання електронної пошти. Це більш безпечний і зрозумілий, ніж sendmail, ще один MTA, який роками використовувався за умовчанням. Його можна використовувати як частину повнофункціонального поштового сервера.

## Встановлення Postfix

Окрім postfix, нам знадобиться _mailx_, щоб перевірити нашу здатність надсилати електронні листи. Щоб установити обидва та будь-які необхідні залежності, введіть наступне в командному рядку сервера Rocky Linux:

`dnf install postfix mailx`

!!! warning "Зміни у Rocky Linux 9.0"

    Ця процедура чудово працює в Rocky Linux 9.0. Різниця тут полягає в тому, звідки походить команда `mailx`. Хоча ви можете встановити його за назвою у 8.x, `mailx` походить із пакета appstream `s-nail` у 9.0. Щоб встановити необхідні пакети, потрібно використовувати:

    ```
    dnf install postfix s-nail
    ```

## Тестування та налаштування Postfix

### Тестування пошти

Перш ніж налаштувати postfix, нам потрібно дізнатися, як буде виглядати пошта, коли вона покине сервер, тому що ми, ймовірно, захочемо це змінити. Для цього запустіть postfix:

`systemctl start postfix`

Потім перевірте його за допомогою команди mail, яка встановлена разом з mailx:

`mail -s "Testing from server" myname@mydomain.com`

Це призведе до появи порожнього рядка. Введіть своє тестове повідомлення тут:

`testing from the server`

Тепер натисніть enter і введіть одну крапку:

`.`

Система відповість наступним чином:

`EOT`

Наша мета зробити це — перевірити, як наша пошта виглядає в зовнішньому світі, що ми можемо відчути з поштового журналу, який стає активним із запуском postfix.

Використовуйте цю команду, щоб переглянути вихідні дані файлу журналу:

`tail /var/log/maillog`

Ви повинні побачити щось подібне, хоча файл журналу може мати різні домени для електронної адреси тощо:

```
Mar  4 16:51:40 hedgehogct postfix/postfix-script[735]: starting the Postfix mail system
Mar  4 16:51:40 hedgehogct postfix/master[737]: daemon started -- version 3.3.1, configuration /etc/postfix
Mar  4 16:52:04 hedgehogct postfix/pickup[738]: C9D42EC0ADD: uid=0 from=<root>
Mar  4 16:52:04 hedgehogct postfix/cleanup[743]: C9D42EC0ADD: message-id=<20210304165204.C9D42EC0ADD@somehost.localdomain>
Mar  4 16:52:04 hedgehogct postfix/qmgr[739]: C9D42EC0ADD: from=<root@somehost.localdomain>, size=457, nrcpt=1 (queue active)
Mar  4 16:52:05 hedgehogct postfix/smtp[745]: connect to gmail-smtp-in.l.google.com[2607:f8b0:4001:c03::1a]:25: Network is unreachable
Mar  4 16:52:06 hedgehogct postfix/smtp[745]: C9D42EC0ADD: to=<myname@mydomain.com>, relay=gmail-smtp-in.l.google.com[172.217.212.26]
:25, delay=1.4, delays=0.02/0.02/0.99/0.32, dsn=2.0.0, status=sent (250 2.0.0 OK  1614876726 z8si17418573ilq.142 - gsmtp)
Mar  4 16:52:06 hedgehogct postfix/qmgr[739]: C9D42EC0ADD: removed
```
"somehost.localdomain" показує, що нам потрібно внести деякі зміни, тому спочатку зупиніть демон postfix:

`systemctl stop postfix`

## Налаштування Postfix

Оскільки ми не налаштовуємо повний, повністю функціональний поштовий сервер, параметри конфігурації, які ми будемо використовувати, не такі великі. Перше, що нам потрібно зробити, це змінити файл _main.cf_ (буквально основний конфігураційний файл для postfix), тому давайте спочатку зробимо резервну копію:

`cp /etc/postfix/main.cf /etc/postfix/main.cf.bak`

Потім відредагуйте його:

`vi /etc/postfix/main.cf`

У нашому прикладі ім’я нашого сервера буде «bruno», а ім’я домену – «ourdomain.com». Знайдіть у файлі рядок:

`#myhostname = host.domain.tld`

Ви можете видалити примітку (#) або додати новий рядок під цим рядком. На основі нашого прикладу рядок буде виглядати так:

`myhostname = bruno.ourdomain.com`

Далі знайдіть рядок для доменного імені:

`#mydomain = domain.tld`

Або видаліть зауваження та змініть його, або додайте новий рядок:

`mydomain = ourdomain.com`

Нарешті, перейдіть у нижню частину файлу та додайте цей рядок:

`smtp_generic_maps = hash:/etc/postfix/generic`

Збережіть зміни (у vi це буде `Shift : wq!`) і закрийте файл.

Перш ніж продовжити редагування загального файлу, нам потрібно побачити, як буде виглядати електронний лист. Зокрема, ми хочемо створити «загальний» файл, на який ми посилалися у файлі _main.cf_ вище:

`vi /etc/postfix/generic`

Цей файл повідомляє Postfix, як має виглядати будь-який електронний лист, що надходить із цього сервера. Пам’ятаєте наш тестовий електронний лист і файл журналу? Тут ми все виправляємо:

```
root@somehost.localdomain       root@bruno.ourdomain.com
@somehost.localdomain           root@bruno.ourdomain.com
```
Тепер нам потрібно сказати Postfix використовувати всі наші зміни. Це робиться за допомогою команди postmap:

`postmap /etc/postfix/generic`

Тепер запустіть postfix і знову перевірте свою електронну пошту, використовуючи ту саму процедуру, що й вище. Тепер ви маєте побачити, що всі екземпляри "localdomain" було змінено на ваш домен.

### Команда date і змінна, яка викликається сьогодні

Не кожна програма використовуватиме той самий формат журналювання для дати. Можливо, вам доведеться підійти творчо до будь-якого сценарію, який ви пишете для звітування за датою.

Припустімо, що ви хочете переглянути свій системний журнал як приклад, отримати все, що стосується dbus-daemon на сьогоднішню дату, і надіслати це собі електронною поштою. (Мабуть, це не найкращий приклад, але він дасть вам уявлення про те, як ми це зробимо.)

Нам потрібно використати змінну в нашому сценарії, яку ми назвемо «сьогодні», і ми хочемо, щоб вона пов’язувалася з виводом команди «date» і відформатувала її певним чином, щоб ми могли отримати потрібні дані з нашого системний журнал (у _/var/log/messages_). Для початку проведемо розслідування.

Спочатку введіть команду date в командному рядку:

`date`

Це повинно дати вам стандартну вихідну дату системи, яка може бути приблизно такою:

`Thu Mar  4 18:52:28 UTC 2021`

Тепер давайте перевіримо наш системний журнал і подивимося, як він записує інформацію. Для цього ми скористаємося командами «more» і «grep»:

`more /var/log/messages | grep dbus-daemon`

Що має дати вам щось на зразок цього:

```
Mar  4 18:23:53 hedgehogct dbus-daemon[60]: [system] Successfully activated service 'org.freedesktop.nm_dispatcher'
Mar  4 18:50:41 hedgehogct dbus-daemon[60]: [system] Activating via systemd: service name='org.freedesktop.nm_dispatcher' unit='dbus-org.freedesktop.nm-dispatcher.service' requested by ':1.1' (uid=0 pid=61 comm="/usr/sbin/NetworkManager --no-daemon " label="unconfined")
Mar  4 18:50:41 hedgehogct dbus-daemon[60]: [system] Successfully activated service 'org.freedesktop.nm_dispatcher
```

Вихідні дані дати та журналу мають бути абсолютно однаковими в нашому сценарії, тому давайте розглянемо, як відформатувати дату за допомогою змінної під назвою «today».

По-перше, давайте подивимося, що ми повинні зробити з датою, щоб отримати той самий результат, що й системний журнал. Ви можете посилатися на [довідкову сторінку Linux](https://man7.org/linux/man-pages/man1/date.1.html) або ввести `man-date` у командному рядку, щоб відкрити сторінку посібника з датою та отримати потрібну інформацію.

Ви побачите, що для форматування дати так само, як у _/var/log/messages_, нам потрібно використовувати рядки формату %b і %e, %b — це місяць із трьома символами, а %e — день із пробілами.

### Сценарій

Для нашого сценарію bash ми бачимо, що ми будемо використовувати команду date і змінну під назвою «today». (Майте на увазі, що "today" є довільним. Ви можете назвати цю змінну "late_for_dinner", якщо хочете!). Ми назвемо наш сценарій у цьому прикладі test.sh і розмістимо його в _/usr/local/sbin_:

`vi /usr/local/sbin/test.sh`

Почнемо з початку нашого сценарію. Зауважте, що незважаючи на те, що коментар у нашому файлі говорить, що ми надсилаємо ці повідомлення на електронну пошту, наразі ми просто надсилаємо їх у стандартний вихід журналу, щоб ми могли перевірити, чи вони правильні.

Крім того, у нашій першій спробі ми захоплюємо всі повідомлення на поточну дату, а не лише повідомлення dbus-daemon. Ми розберемося з цим найближчим часом.

Інша річ, про яку слід пам’ятати, це те, що команда grep поверне ім’я файлу у вихідних даних, чого ми не хочемо в цьому випадку, тому ми додали опцію «-h» до grep, щоб видалити префікс назви файлу. Крім того, коли змінну «today» встановлено, нам потрібно шукати всю змінну як рядок, тому нам знадобиться все в лапках:

```
#!/bin/bash

# встановити рядок дати відповідно до /var/log/messages
сьогодні=`дата +"%b %e"`

# отримати повідомлення dbus-daemon і надіслати їх електронною поштою
grep -h "$today" /var/log/messages
```

На цьому все, тож збережіть зміни, а потім зробіть сценарій виконуваним:

`chmod +x /usr/local/sbin/test.sh`

А потім перевіримо:

`/usr/local/sbin/test.sh`

Якщо все працює правильно, ви маєте отримати довгий список усіх повідомлень у /var/log/messages від сьогодні, включаючи, але не обмежуючись повідомленнями dbus-daemon.  Якщо так, то наступним кроком буде обмеження повідомлень повідомленнями демона dbus. Отже, давайте знову змінимо наш сценарій:

`vi /usr/local/sbin/test.sh`

```
#!/bin/bash

# встановити рядок дати відповідно до /var/log/messages
сьогодні=`дата +"%b %e"`

# отримати повідомлення dbus-daemon і надіслати їх електронною поштою
grep -h "$today" /var/log/messages | grep dbus-демон
```

Повторний запуск сценарію має отримати лише повідомлення демона dbus і лише ті, які виникли сьогодні (щоразу, коли ви виконуєте цей посібник).

Однак є ще один останній крок. Пам’ятайте, нам потрібно надіслати це електронною поштою адміністратору для перевірки. Крім того, оскільки ми використовуємо лише _postfix_ на цьому сервері для звітування, ми не хочемо залишати службу запущеною, тому ми запустимо її на початку сценарію а потім зупиніть його в кінці. Тут ми представимо команду _sleep_, щоб зробити паузу на 20 секунд, щоб переконатися, що електронний лист надіслано перед закриттям _postfix_ знову вниз.  Це остаточне редагування додає проблеми зупинки, запуску та сну, які щойно обговорювалися, а також передає вміст на електронну пошту адміністратора.

`vi /usr/local/sbin/test.sh`

І змініть сценарій:

```
#!/bin/bash

# запуск postfix
/usr/bin/systemctl start postfix

# встановити рядок дати відповідно до /var/log/messages
today=`date +"%b %e"`

# візьміть повідомлення dbus-daemon і надішліть їх електронною поштою
grep -h "$today" /var/log/messages | grep dbus-daemon | mail -s "dbus-daemon messages for today" myname@mydomain.com

# перш ніж продовжити, переконайтеся, що електронний лист закінчено
sleep 20

# зупинити postfix
/usr/bin/systemctl stop postfix
```

Запустіть сценарій знову, і тепер ви повинні отримати електронний лист від сервера з повідомленням dbus-daemon.

Тепер ви можете використовувати [crontab](../automation/cron_jobs_howto.md), щоб запланувати його виконання в певний час.

## Висновок

Використання postfix може допомогти вам відстежувати журнали процесу, які ви хочете контролювати. Ви можете використовувати його разом із сценаріями bash, щоб отримати чітке розуміння системних процесів і бути поінформованим у разі виникнення проблем.
