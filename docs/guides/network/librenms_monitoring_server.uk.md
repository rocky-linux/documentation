- - -
title: Сервер моніторингу LibreNMS author: Steven Spencer contributors: Ezequiel Bruni tested_with: 8.5, 8.6, 9.0 tags:
  - моніторинг
  - мережа
- - -

# Сервер моніторингу LibreNMS

## Вступ

Мережевим і системним адміністраторам майже завжди потрібна певна форма моніторингу. Це може включати графічне використання пропускної здатності на кінцевих точках маршрутизатора, моніторинг підвищення/зниження служб, що працюють на різних серверах, і багато іншого. Існує багато варіантів моніторингу, але один ідеальний варіант із багатьма, якщо не всіма, компонентами моніторингу, доступними під одним дахом, — це LibreNMS.

Цей документ є лише відправною точкою для LibreNMS. Ми надамо вам чудову (і розширену) документацію проекту, щоб отримати більше варіантів. Є багато інших варіантів моніторингу, які цей автор використовував раніше, Nagios і Cacti — це два, але LibreNMS пропонує те, що пропонують ці два проекти окремо, в одному місці.

Незважаючи на те, що інсталяція відбуватиметься відповідно до [офіційних інструкцій із інсталяції, наведених тут](https://docs.librenms.org/Installation/Install-LibreNMS/), ми додали деякі пояснення та незначні зміни, які роблять цю процедуру кращою за чудовий документ.

## Передумови, припущення та умовності

* Сервер або контейнер (так, LibreNMS працюватиме в контейнері, однак, якщо вам потрібно багато чого контролювати, найкращим варіантом буде інсталювати його на апаратному забезпеченні) під керуванням Rocky Linux. Усі команди передбачають нову інсталяцію Rocky Linux.
* Припущення: ви можете запускати команди від імені root або _sudo_ для цього
* Практичні знання інструментів командного рядка, включаючи текстові редактори, такі як _vi_
* Ми припускаємо використання SNMP v2. Якщо ви хочете використовувати SNMP v3, він підтримується LibreNMS і працюватиме. Ви повинні змінити конфігурацію та параметри SNMP на своїх пристроях, щоб відповідати версії 3.
* Хоча ми включили процедуру SELinux у цей документ, контейнер, який ми використовуємо в лабораторії, не включає її за замовчуванням. З цієї причини процедура SELinux **не** була лабораторно перевірена.
* У цьому документі в прикладах використовується редактор _vi_, як згадувалося. Коли в документі написано зберегти зміни та вийти, це робиться за допомогою `SHIFT:wq!`
* Процедура вимагає певних навичок усунення несправностей, включаючи моніторинг журналів, веб-тестування тощо

## Встановлення пакетів

Ці команди слід вводити від імені користувача root. Перш ніж почати, зауважте, що ця процедура встановлення зосереджена на *httpd*, а не на *nginx*. Якщо ви віддаєте перевагу останньому, дотримуйтеся [інструкцій зі встановлення Librenms](https://docs.librenms.org/Installation/Install-LibreNMS/) і вказівок.

Ми припускаємо нову інсталяцію, тому нам потрібно зробити кілька речей зі сховищами, перш ніж продовжити. Спочатку нам потрібно встановити репозиторій EPEL (додаткові пакети для Enterprise Linux):


```
dnf install -y epel-release
```

Для поточної версії LibreNMS потрібна мінімальна версія PHP 8.1. Пакетом за замовчуванням у Rocky Linux 9.0 є PHP 8.0, тому ви повинні ввімкнути сторонній репозиторій (також у Rocky Linux 8.6) для цієї новішої версії.

Для цього ми встановимо репозиторій REMI. Версія сховища, яке ви встановите, залежатиме від продуктивності Rocky Linux, який ви використовуєте. Ми припускаємо версію 9 нижче, але змініть це відповідно до версії, яку ви використовуєте:

```
dnf install http://rpms.remirepo.net/enterprise/remi-release-9.rpm
```

Після встановлення репозиторіїв EPEL і REMI настав час інсталювати пакети, які нам знадобляться:

```
dnf install bash-completion cronie fping git httpd ImageMagick mariadb-server mtr net-snmp net-snmp-utils nmap php81-php-fpm php81-php-cli php81-php-common php81-php-curl php81-php-gd php81-php-json php81-php-mbstring php81-php-process php81-php-snmp php81-php-xml php81-php-zip php81-php-mysqlnd python3 python3-PyMySQL python3-redis python3-memcached python3-pip python3-systemd rrdtool unzip wget
```

Усі ці пакети представляють певну частину набору функцій LibreNMS.

## Налаштування користувача librenms

Для цього скопіюйте та вставте (або введіть) наступне:

```
useradd librenms -d /opt/librenms -M -r -s "$(which bash)"
```

За допомогою цієї команди ми встановлюємо каталог за умовчанням для нашого нового користувача на "/opt/librenms", однак параметр "-M" говорить "не створювати каталог." Причина, звичайно, полягає в тому, що ми будемо створювати його під час встановлення LibreNMS. "-r" говорить про те, щоб зробити цього користувача системним обліковим записом, а "-s" говорить про встановлення оболонки (у цьому випадку на "bash")

## Завантажте LibreNMS і встановіть дозволи

Все завантаження виконується через git. Можливо, ви знайомі з цим процесом, оскільки він використовується для багатьох проектів. Спочатку перейдіть до каталогу /opt:

```
cd /opt
```

Потім клонуйте репозиторій:

```
git clone https://github.com/librenms/librenms.git
```

Далі змініть дозволи для каталогу:

```
chown -R librenms:librenms /opt/librenms
chmod 771 /opt/librenms
setfacl -d -m g::rwx /opt/librenms/rrd /opt/librenms/logs /opt/librenms/bootstrap/cache/ /opt/librenms/storage/
setfacl -R -m g::rwx /opt/librenms/rrd /opt/librenms/logs /opt/librenms/bootstrap/cache/ /opt/librenms/storage/
```

Команда _setfacl_ розшифровується як «встановити списки контролю доступу до файлів» і є іншим способом захисту каталогів і файлів.

## Встановлення залежності PHP як librenms

Усі наведені вище команди було виконано як root або _sudo_, але PHP-залежності в LibreNMS потрібно встановити як користувач librenms. Для цього запустіть:

```
su - librenms
```

А потім введіть наступне:

```
./scripts/composer_wrapper.php install --no-dev
```

Після завершення сценарію поверніться до root:

```
exit
```

### Помилка встановлення залежності PHP. Обхідний шлях

У документації LibreNMS зазначено, що описана вище процедура може не завершитися, якщо ви перебуваєте за проксі-сервером. Я виявив, що це може вийти з ладу також з інших причин. З цієї причини я додав процедуру встановлення Composer пізніше.

## Встановлення часового поясу

Нам потрібно забезпечити правильне налаштування системи та PHP. Ви можете знайти список [дійсних налаштувань часового поясу для PHP тут](https://php.net/manual/en/timezones.php). Наприклад, для центрального часового поясу загальним записом буде "Америка/Чикаго". Почнемо з редагування файлу php.ini:

```
vi /etc/opt/remi/php81/php.ini
```

Знайдіть рядок `date.timezone` і змініть його. Зауважте, що це позначено, тому видаліть ";" від початку рядка та додайте свій часовий пояс після знака "=". Для нашого прикладу центрального часового поясу ми використаємо:

```
date.timezone = America/Chicago
```

Збережіть зміни та закрийте файл php.ini.

Нам також потрібно переконатися, що системний часовий пояс правильний. Знову ж таки, використовуючи наш центральний часовий пояс як приклад, ми б зробили це за допомогою:

```
timedatectl set-timezone America/Chicago
```

## Налаштування MariaDB

Перш ніж перейти до налаштування бази даних, необхідної для LibreNMS, виконайте [процедуру MariaDB](../database/database_mariadb-server.md) і, зокрема, розділ «Захист mariadb-сервера», а потім поверніться сюди, щоб отримати ці конкретні налаштування. Перше, що нам потрібно зробити, це змінити файл mariadb-server.cnf:

```
vi /etc/my.cnf.d/mariadb-server.cnf
```

І додайте такі рядки до розділу "[Mysqld]":

```
innodb_file_per_table=1
lower_case_table_names=0
```

Потім увімкніть і перезапустіть сервер mariadb:

```
systemctl enable mariadb
systemctl restart mariadb
```

Тепер отримайте доступ до mariadb як користувач root. Не забувайте використовувати пароль, який ви створили під час виконання розділу «Захист mariadb-сервера», який ви виконали вище:


```
mysql -u root -p
```

Далі нам потрібно внести певні зміни в LibreNMS. За допомогою наведеної нижче команди не забудьте змінити пароль "password" на щось безпечне та задокументувати те, що знаходиться в безпечному місці, наприклад, менеджер паролів, щоб мати його пізніше.

У підказці mysql запустіть:

```
CREATE DATABASE librenms CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'librenms'@'localhost' IDENTIFIED BY 'password';
GRANT ALL PRIVILEGES ON librenms.* TO 'librenms'@'localhost';
FLUSH PRIVILEGES;
```

Зробивши це, введіть «exit», щоб вийти з mariadb.

## Налаштувати PHP-FPM

Цей розділ не змінився в офіційній документації, за винятком шляху до файлу. Спочатку скопіюйте www.conf:

```
cp /etc/opt/remi/php81/php-fpm.d/www.conf /etc/opt/remi/php81/php-fpm.d/librenms.conf
```

Далі змініть файл librenms.conf:

```
vi /etc/opt/remi/php81/php-fpm.d/librenms.conf
```

Змініть "[www]" на ["librenms]"

Змініть користувача та групу на "librenms":

```
user = librenms
group = librenms
```

І, нарешті, змініть рядок «listen», щоб відобразити унікальну назву:

```
listen = /run/php-fpm-librenms.sock
```

Збережіть зміни та вийдіть із файлу. Якщо це єдина веб-служба, яка працюватиме на цій машині, не соромтеся видалити старий файл www.conf, який ми скопіювали:

```
rm -f /etc/opt/remi/php81/php-fpm.d/www.conf
```

## Налаштування Apache

Зазвичай ми використовуємо процедуру [Apache із підтримкою сайтів](../web/apache-sites-enabled.md) для налаштування будь-яких веб-служб, але в цьому випадку ми використовуємо налаштування за замовчуванням.

Зауважте, що якщо ви хочете використати цю процедуру, вам потрібно розмістити файл конфігурації в /etc/httpd/sites-available, а потім виконати процес, щоб пов’язати його з sites-enabled. Однак коренем документа за замовчуванням буде **не** /var/www/sub-domains/librenms/html, а /opt/librenms/html.

Знову ж таки, ми не використовуємо цю процедуру, а лише дотримуємося рекомендованих налаштувань за умовчанням. Для цього створіть цей файл:

```
vi /etc/httpd/conf.d/librenms.conf
```

І розмістити в цьому файлі наступне:

```
<VirtualHost *:80>
  DocumentRoot /opt/librenms/html/
  ServerName  librenms.example.com

  AllowEncodedSlashes NoDecode
  <Directory "/opt/librenms/html/">
    Require all granted
    AllowOverride All
    Options FollowSymLinks MultiViews
  </Directory>

  # Enable http authorization headers
  <IfModule setenvif_module>
    SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1
  </IfModule>

  <FilesMatch ".+\.php$">
    SetHandler "proxy:unix:/run/php-fpm-librenms.sock|fcgi://localhost"
  </FilesMatch>
</VirtualHost>
```

Ви також повинні видалити старий сайт за замовчуванням, welcome.conf:

```
rm /etc/httpd/conf.d/welcome.conf
```

Нарешті, нам потрібно ввімкнути _httpd_ і _php-fpm_:

```
systemctl enable --now httpd
systemctl enable --now php81-php-fpm
```

## SELinux

Зверніть увагу: якщо ви не плануєте використовувати SELinux, пропустіть цей розділ і перейдіть до наступного розділу. Це також може стосуватися вас, якщо ви використовуєте LibreNMS у контейнері, який не підтримує SELinux на рівні контейнера або не включає його за замовчуванням.

Щоб налаштувати все за допомогою SELinux, вам знадобиться встановити додатковий пакет:

```
dnf install policycoreutils-python-utils
```

### Налаштування контекста LibreNMS

Щоб LibreNMS належним чином працював із SELinux, потрібно встановити наступні контексти:

```
semanage fcontext -a -t httpd_sys_content_t '/opt/librenms/html(/.*)?'
semanage fcontext -a -t httpd_sys_rw_content_t '/opt/librenms/(logs|rrd|storage)(/.*)?'
restorecon -RFvv /opt/librenms
setsebool -P httpd_can_sendmail=1
setsebool -P httpd_execmem 1
chcon -t httpd_sys_rw_content_t /opt/librenms/.env
```

### Дозволити fping

Створіть будь-де файл під назвою `http_fping.tt`, який пізніше буде встановлено за допомогою команди. Вміст цього файлу:

```
module http_fping 1.0;

require {
type httpd_t;
class capability net_raw;
class rawip_socket { getopt create setopt write read };
}

#============= httpd_t ==============
allow httpd_t self:capability net_raw;
allow httpd_t self:rawip_socket { getopt create setopt write read };
```

Тепер встановіть вміст цього файлу за допомогою таких команд:

```
checkmodule -M -m -o http_fping.mod http_fping.tt
semodule_package -o http_fping.pp -m http_fping.mod
semodule -i http_fping.pp
```

Якщо у вас виникли проблеми та ви підозрюєте, що це може бути пов’язано з проблемою SELinux, виконайте наступне:

```
audit2why < /var/log/audit/audit.log
```

## Конфігурація брандмауера - `firewalld`

Ми додамо інструкції щодо _firewalld_ з офіційної документації.

Команда для використання правил дозволу _firewalld_ така:

```
firewall-cmd --zone public --add-service http --add-service https
firewall-cmd --permanent --zone public --add-service http --add-service https
```

Автор має проблеми з цим спрощеним набором правил _firewalld_. Це правило дозволяє вашим веб-сервісам бути відкритими для світу, але чи цього ви хочете від сервера моніторингу?

Я б сказав, що зазвичай це **не**. Якщо вам потрібен більш детальний підхід до використання _firewalld_, перегляньте [цей документ](../security/firewalld.md), а потім внесіть відповідні зміни до своїх правил _firewalld_.

## Увімкнути символьне посилання та автозаповнення вкладок для команд lnms

По-перше, нам потрібне символічне посилання на нашу команду _lnms_, щоб її можна було виконувати будь-де:

```
ln -s /opt/librenms/lnms /usr/bin/lnms
```

Далі нам потрібно налаштувати його для автозаповнення:

```
cp /opt/librenms/misc/lnms-completion.bash /etc/bash_completion.d/
```

## Налаштувати snmpd

_SNMP_ означає "Простий протокол керування мережею" та використовується в багатьох програмах моніторингу для отримання даних. Версія 2, яку ми тут використовуємо, включає «рядок спільноти», специфічний для вашого середовища.

Вам потрібно буде призначити цей «рядок спільноти» вашим мережевим пристроям, які ви хочете контролювати, щоб _snmpd_ («d» тут означає демон) міг знайти його. Якщо ваша мережа існує протягом певного часу, можливо, у вас уже є «рядок спільноти», який ви використовуєте.

Спочатку скопіюйте файл snmp.conf з LibreNMS:

```
cp /opt/librenms/snmpd.conf.example /etc/snmp/snmpd.conf
```

Далі відредагуйте цей файл і змініть рядок спільноти з "RANDOMSTRINGGOESHERE" на будь-який рядок вашої спільноти. У нашому прикладі ми змінюємо його на "LABone":

```
vi /etc/snmp/snmpd.conf
```

І змініть цей рядок:

```
com2sec readonly  default         RANDOMSTRINGGOESHERE
```

на

```
com2sec readonly  default         LABone
```

Тепер збережіть зміни та вийдіть.

## Автоматизація за допомогою завдання Cron

Виконайте такі команди, щоб налаштувати завдання cron:

```
cp /opt/librenms/librenms.nonroot.cron /etc/cron.d/librenms
```

Опитувач має запуститися один раз, навіть якщо опитування нічого не буде до запуску процедури веб-налаштування. Це заощаджує багато часу, щоб визначити, що не так, коли пізніше ви отримуєте помилки опитувальника в розділі перевірки.

Користувач «librenms» запускає опитувальник, і хоча можна було б переключитися на цього користувача та запустити файли cron, справді краще дозволити опитувальнику зробити це самостійно, тому переконайтеся, що між ними пройшло принаймні 5 хвилин цей розділ і розділ «Веб-налаштування» нижче.

## Ротація Журналу

LibreNMS з часом створить великий набір журналів. Для цього вам потрібно буде налаштувати ротацію журналу, щоб вона не займала надто багато місця на диску. Для цього просто виконайте цю команду зараз:

```
cp /opt/librenms/misc/librenms.logrotate /etc/logrotate.d/librenms
```

## Встановлення Composer

Для поточної інсталяції потрібен PHP Composer (згаданий у попередній процедурі). Якщо встановлення, яке ви запустили раніше, не вдалось, ви повинні це зробити.

Перш ніж почати, нам потрібно прив’язати нашу поточну версію двійкового файлу `php` до розташування в шляху. Оскільки ми використовували інсталяцію REMI, щоб отримати правильну версію PHP, її не встановлено в межах шляху.

Це досить легко виправити за допомогою символічного посилання, і це значно полегшить ваше життя, коли ви пройдете наступні кроки:

```
ln -s /opt/remi/php81/root/usr/bin/php /usr/bin/php
```

Тепер перейдіть на [веб-сайт Composer](https://getcomposer.org/download/) і переконайтеся, що наступні кроки не змінилися. Якщо ні, виконайте ці команди десь на машині (розташування не має значення, оскільки ми перемістимо композитор, коли закінчимо):

```
php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
php -r "if (hash_file('sha384', 'composer-setup.php') === '55ce33d7678c5a611085589f1f3ddf8b3c52d662cd01d4ba75c0ee0459970c2200a51f492d557530c71c15d8dba01eae') { echo 'Installer verified'; } else { echo 'Installer corrupt'; unlink('composer-setup.php'); } echo PHP_EOL;"
php composer-setup.php
php -r "unlink('composer-setup.php');"
```

Перемістіть його в місце на нашому шляху. Для цього ми використовуємо `/usr/local/bin/`:

```
mv composer.phar /usr/local/bin/composer
```

## Веб-налаштування

Тепер, коли ми встановили та налаштували всі компоненти, нашим наступним кроком є завершення встановлення через Інтернет. У нашій лабораторній версії ми не налаштували ім’я хоста, тому, щоб завершити налаштування, нам потрібно перейти на веб-сервер за IP-адресою.

IP-адреса нашої лабораторної машини – 192.168.1.140, тому нам потрібно перейти за такою адресою у веб-браузері, щоб завершити встановлення:

`http://192.168.1.140/librenms`

Якщо припустити, що все працює правильно, вас має бути перенаправлено до перевірки перед встановленням. Якщо припустити, що всі вони позначені зеленим кольором, ми зможемо продовжити.

![Попередні перевірки LibreNMS](../images/librenms_prechecks.png)

Під логотипом LibreNMS є чотири кнопки. Перша кнопка зліва призначена для попередніх перевірок. Наша наступна кнопка – для бази даних. Вам знадобиться пароль, який ви встановили для користувача бази даних «librenms» раніше в процесі.

Якщо ви старанно стежили за цим, ви зберегли це в безпечному місці. Далі натисніть кнопку «База даних». Тут необхідно вказати «Користувач» і «Пароль». Зробивши це, натисніть кнопку «Перевірити облікові дані».

![База даних LibreNMS](../images/librenms_configure_database.png)

Після цього натисніть кнопку "Build Database", якщо вона знову стане зеленою.

![Статус бази даних LibreNMS](../images/librenms_configure_database_status.png)

Після цього кнопка «Create Admin User» стане активною, тому натисніть її. Вам буде запропоновано ввести ім’я користувача адміністратора. У нашому прикладі ми просто будемо використовувати «admin» і пароль для цього користувача.

Переконайтеся, що пароль надійний, і зареєструйте його в безпечному місці, наприклад у менеджері паролів. Вам також потрібно буде заповнити адресу електронної пошти користувача-адміністратора. Коли все це буде завершено, просто натисніть кнопку «Додати користувача».

![Користувач-адміністратор LibreNMS](../images/librenms_administrative_user.png)

Коли ви це зробите, ви побачите екран «Finish Install». Для завершення встановлення має залишитися лише один пункт: рядок із запитом «підтвердити встановлення».

Натисніть на посилання. Після того, як ви це зробите, і все буде успішно, ви будете перенаправлені на сторінку входу. Увійдіть за допомогою облікового запису адміністратора та пароля.

## Додавання пристроїв

Знову ж таки, одним із наших припущень було те, що ви використовуєте SNMP v2. Пам’ятайте, що кожен пристрій, який ви додаєте, має бути членом вашої спільноти. Ми додаємо тут два пристрої як приклади. Робоча станція Ubuntu і сервер CentOS.

Ймовірно, вам доведеться додати керовані комутатори, маршрутизатори та інші пристрої. Автор може сказати вам з досвіду, що додавати комутатори та маршрутизатори легше, ніж додавати робочі станції та сервери, тому ми включаємо більш складні приклади.

### Налаштування робочої станції Ubuntu

Спочатку встановіть _snmpd_ на робочу станцію, а також оновіть пакунки, просто для безпеки:

```
sudo update && sudo apt-get upgrade && sudo apt-get install snmpd
```

Далі вам потрібно змінити файл snmpd.conf:

```
sudo vi /etc/snmpd/snmpd.conf
```

Знайдіть рядки, які описують вашу робочу станцію, і змініть їх на речі, які ідентифікують робочу станцію. Ці рядки показано нижче:

```
sysLocation    Desktop
sysContact     Username <user@mydomain.com>
```

За замовчуванням, коли ви встановлюєте snmpd на Ubuntu, він прив’язується лише до локальної адреси. Він не прослуховує IP-адресу вашого пристрою. Це не дозволить LibreNMS підключитися до нього. Нам потрібно виділити цей рядок:

```
agentaddress  127.0.0.1,[::1]
```

І додайте новий рядок, який виглядає наступним чином: (У цьому прикладі IP-адреса нашої робочої станції – 192.168.1.122, а UDP-порт, який ми встановлюємо, – «161»)

```
agentAddress udp:127.0.0.1:161,udp:192.168.1.122:161
```

Далі нам потрібно вказати рядок спільноти доступу лише для читання. Знайдіть наведені нижче рядки та відзначте їх. (Зверніть увагу, що ми показуємо їх, як зазначено нижче.)

```
#rocommunity public default -V systemonly
#rocommunity6 public default -V systemonly
```

Далі додайте новий рядок:

```
rocommunity LABone
```

Тепер збережіть зміни та вийдіть.

Увімкніть і запустіть _snmpd_:

```
sudo systemctl enable snmpd
sudo systemctl start snmpd
```

Якщо ви використовуєте брандмауер на внутрішніх робочих станціях, ви повинні змінити брандмауер, щоб дозволити UDP-трафік із сервера моніторингу або мережі. LibreNMS також хоче мати можливість «пінгувати» ваш пристрій, тому переконайтеся, що порт 8 icmp дозволено на сервері.

### Налаштування сервера CentOS або Rocky Linux

Ми припускаємо, що ви root або можете стати _sudo_. Спочатку нам потрібно встановити деякі пакети:

```
dnf install net-snmp net-snmp-utils
```

Далі ми хочемо створити файл snmpd.conf. Замість того, щоб намагатися переглядати файл, який включено, перемістіть цей файл, щоб перейменувати його та створіть абсолютно новий порожній файл:

```
mv /etc/snmp/snmpd.conf /etc/snmp/snmpd.conf.orig
```

та

```
vi /etc/snmp/snmpd.conf
```

Потім скопіюйте наведене нижче в новий файл:

```
# Map 'LABone' community to the 'AllUser'
# sec.name source community
com2sec AllUser default LABone
# Map 'ConfigUser' to 'ConfigGroup' for SNMP Version 2c
# Map 'AllUser' to 'AllGroup' for SNMP Version 2c
# sec.model sec.name
group AllGroup v2c AllUser
# Define 'SystemView', which includes everything under .1.3.6.1.2.1.1 (or .1.3.6.1.2.1.25.1)
# Define 'AllView', which includes everything under .1
# incl/excl subtree
view SystemView included .1.3.6.1.2.1.1
view SystemView included .1.3.6.1.2.1.25.1.1
view AllView included .1
# Give 'ConfigGroup' read access to objects in the view 'SystemView'
# Give 'AllGroup' read access to objects in the view 'AllView'
# context model level prefix read write notify
access AllGroup "" any noauth exact AllView none none
```

CentOS і Rocky використовують угоду про відображення, щоб керувати справами. Наведений вище файл добре прокоментовано, щоб ви могли дізнатися, що відбувається, але він не містить усього безладу оригінального файлу.

Після внесення змін збережіть їх і закрийте файл.

Тепер нам потрібно ввімкнути та запустити _snmpd_:

```
systemctl enable snmpd
systemctl start snmpd
```

#### Firewall

Якщо ви використовуєте сервер, ви **використовуєте** брандмауер.  Якщо ви використовуєте _firewalld_ (як і має бути), ми припустимо, що ми використовуємо тут «довірену» зону, і ми просто хочемо дозволити весь трафік з нашого сервера моніторингу, 192.168.1.140:

```
firewall-cmd --zone=trusted --add-source=192.168.1.140 --permanent
```

Знову ж таки, ми припустили тут «довірену» зону, але вам може знадобитися щось інше, навіть «публічне». Перш ніж додавати їх, подумайте про свої правила та їх вплив.

## Додавання пристроїв у Librenms

Тепер, коли наші зразки пристроїв налаштовано на прийом трафіку SNMP від нашого сервера LibreNMS, наступним кроком буде додавання цих пристроїв до LibreNMS. Ми припускаємо, що у вас відкрито веб-інтерфейс для LibreNMS; якщо так, ви побачите, що у вас немає доданих пристроїв, і попросять додати один.

Тож зробіть це. Коли ви натиснете, щоб додати пристрій, ви побачите такий екран:

![LibreNMS Додати пристрій](../images/librenms_add_device.png)

Додайте інформацію, яку ми використовували для наших тестових пристроїв. У нашому випадку ми використовуємо IP для запуску робочої станції Ubuntu; у нашому прикладі це 192.168.1.122. Ми повинні додати рядок спільноти в поле «Community», тому введіть тут «LABone».

Тепер натисніть кнопку «Додати пристрій». Припускаючи, що ви зробили все правильно, додаючи пристрій, ваш пристрій має бути успішно додано.

Якщо ви зіткнулися з помилкою «не вдалося додати», перегляньте налаштування SNMP для робочої станції або брандмауера, якщо він існує. Далі ми повторюємо процес «Додати пристрій» для нашого сервера CentOS.

## Отримання сповіщень

Як ми вже говорили, цей документ лише допоможе вам почати роботу з LibreNMS. Існує багато додаткових елементів конфігурації, розширений API (інтерфейс прикладного програмування), система сповіщень, яка надає величезну кількість варіантів доставки під назвою «Транспорти», і багато іншого.

Ми не створюватимемо жодних правил сповіщення. Натомість ми відредагуємо вбудоване правило сповіщень «Пристрій не працює! Через відсутність відповіді ICMP", який попередньо налаштовано з коробки. Для «Транспорту» ми залишимо «Пошту», яка є просто електронною поштою. Просто знайте, що ви не обмежені.

Пошта має працювати, щоб використовувати електронну пошту для нашого транспорту. Використовуйте цю [Процедуру Postfix](../email/postfix_reporting.md), щоб розпочати це.

Виконайте цю процедуру, щоб налаштувати postfix, щоб він правильно визначав, звідки надходять повідомлення, але ви можете зупинитися після процесу налаштування та повернутися сюди.

### Транспорти

Нам потрібен спосіб надсилати сповіщення. Як зазначалося раніше, LibreNMS підтримує величезну кількість транспортів. Ми зробимо наше сповіщення електронною поштою, визначене як транспорт "Пошта". Щоб налаштувати транспорт:

1. Перейдіть до інформаційної панелі
2. Наведіть вказівник миші на «Сповіщення»
3. Перейдіть до «Alert Transports» і натисніть на нього
4. Натисніть кнопку «Create alert transport» (зверніть увагу на кнопку «Create transport group». Ви можете використовувати це, щоб надсилати сповіщення кільком особам)
5. У полі «Назва транспорту:» введіть «Сповіщення електронною поштою»
6. У полі «Тип транспорту:» у розкривному меню виберіть «Пошта»
7. Переконайтеся, що для поля «Попередження за замовчуванням:» встановлено значення «Увімк.»
8. У полі «Електронна адреса:» введіть адресу електронної пошти адміністратора

### Організація пристроїв у групи

Найкращий спосіб налаштувати сповіщення – це логічно організувати свої пристрої. Наразі ми маємо робочу станцію та сервер у пристроях. Хоча зазвичай ми не хочемо поєднувати ці два, ми це зробимо для цього прикладу.

Майте на увазі, що наш приклад також зайвий, оскільки існує група «Усі пристрої», яка також підійде для цього. Щоб налаштувати групу пристроїв:

1. Перейдіть до інформаційної панелі
2. Наведіть вказівник миші на «Пристрої»
3. Перейдіть до «Керування групами» та натисніть на нього
4. Натисніть кнопку «+ Нова група пристроїв»
5. У полі «Назва» введіть «ICMP Group»
6. У полі опису введіть те, що, на вашу думку, допоможе описати групу
7. Змініть поле "Тип" з "Динамічний" на "Статичний"
8. Додайте обидва пристрої в поле «Вибрати пристрої», а потім просто збережіть зміни

### Налаштування правил сповіщень

Далі налаштуйте правило сповіщення. За замовчуванням у LibreNMS уже створено кілька правил сповіщень:

1. Перейдіть до інформаційної панелі
2. Наведіть вказівник миші на «Сповіщення»
3. Перейдіть до «Правил сповіщень» і натисніть на нього
4. Верхнє активне правило на дисплеї буде «Device Down! Due to no ICMP response» Перейдіть до «Дії» (крайній правий стовпець) і натисніть значок олівця, щоб редагувати правило.
5. Залиште всі поля вгорі, як є, і перейдіть до поля «Відповідність списку пристроїв, груп і місць:» і клацніть усередині поля
6. Виберіть зі списку «ICMP Group»
7. Переконайтеся, що поле «Усі пристрої, крім у списку:» вимкнено
8. Клацніть у полі «Transports:» і виберіть «Mail: Alert By Email» і збережіть своє правило.

Перед збереженням ваше правило має виглядати приблизно так:

![Правило сповіщень LibreNMS](../images/librenms_alert_rule.png)

Тепер ці два пристрої повинні повідомляти вас електронною поштою, якщо вони не працюють і коли вони відновляться.

## Висновки

LibreNMS — це потужний інструмент моніторингу з повним набором функцій в одній програмі. Ми лише _тільки_ подряпали поверхню можливостей. Ми не показали вам деякі з видимих екранів.

Наприклад, як тільки ви додаєте пристрої, припускаючи, що всі властивості SNMP встановлено правильно, ви отримаєте графіки пропускної здатності, використання пам’яті та використання ЦП на кожному пристрої. Ми не показали вам безліч доступних транспортів, крім «Пошти».

Усе це сказане, ми показали вам достатньо в цьому документі, щоб добре почати моніторинг вашого середовища. LibreNMS потребує деякого часу, щоб освоїти всі елементи. Щоб отримати додаткову інформацію, відвідайте [чудову документацію](https://docs.librenms.org/) проекту.
