---
title: WireGuard VPN
author: Joseph Brinkman
contributors: Steven Spencer, Ganna Zhyrnova
tested_with: 9.4
tags:
  - безпека
  - vpn
---

## Вступ

[WireGuard](https://www.wireguard.com/) – це безкоштовна однорангова (P2P) віртуальна приватна мережа (VPN) з відкритим кодом. Це легка та безпечна сучасна альтернатива звичайним VPN з великими кодовими базами, які покладаються на з’єднання TCP. Оскільки WireGuard є P2P VPN, кожен комп’ютер, доданий до мережі WireGuard, спілкується безпосередньо один з одним. У цьому посібнику використовується hub-spoke модель, де одноранговому вузлу WireGuard призначено публічну IP-адресу як шлюз для пропускання всього трафіку. Це дозволяє трафіку WireGuard обходити Carrier Grade NAT (CGNAT) без увімкнення переадресації портів на маршрутизаторі. Для цього потрібна система Rocky Linux із публічною IP-адресою. Найпростіший спосіб досягти цього — розгорнути віртуальний приватний сервер (VPS) через хмарного постачальника за вашим вибором. На момент написання статті Google Cloud Platform пропонує безкоштовний рівень для своїх екземплярів e2-micro.

## Передумови та припущення

Мінімальні вимоги до цієї процедури такі:

- Можливість запускати команди від імені користувача root або використовувати `sudo` для підвищення привілеїв.
- Система Rocky Linux із загальнодоступною IP-адресою

## Встановлення WireGuard

Встановіть додаткові пакети для Enterprise Linux (EPEL):

```bash
sudo dnf install epel-release
```

Оновіть пакети вашої системи:

```bash
sudo dnf upgrade
```

Встановити WireGuard:

```bash
sudo dnf install wireguard-tools
```

## Налаштування сервера WireGuard

Створіть папку для зберігання конфігураційних файлів і ключів WireGuard:

```bash
sudo mkdir -p /etc/wireguard
```

Створіть файл конфігурації з назвою на ваш вибір, що закінчується розширенням `.conf`:

!!! note "Примітка"

```
Ви можете створити кілька тунелів WireGuard VPN на одній машині, кожен з яких використовує різні файли конфігурації, мережеву адресу та UDP-порт.
```

```bash
sudo touch /etc/wireguard/wg0.conf
```

Створіть нову пару закритого та відкритого ключів для сервера WireGuard:

```bash
wg genkey | sudo tee /etc/wireguard/privatekey | wg pubkey | sudo tee /etc/wireguard/publickey
```

Відредагуйте файл конфігурації за допомогою обраного вами редактора.

```bash
sudo vim /etc/wireguard/wg0.conf
```

Вставте наступне:

```bash
[Interface]
PrivateKey = server_privatekey
Address = x.x.x.x/24
ListenPort = 51820
```

Ви повинні замінити `privatekey` на закритий ключ, згенерований раніше. Ви можете переглянути закритий ключ за допомогою:

```bash
sudo cat /etc/wireguard/privatekey
```

Далі вам потрібно буде замінити `x.x.x.x/24` на мережеву адресу в межах діапазону приватних IP-адрес, визначеного [RFC 1918] (https://datatracker.ietf.org/doc/html/rfc1918). Наша демонстраційна приватна IP-адреса в цьому посібнику – `10.255.255.0/24`.

Нарешті, ви можете вибрати будь-який порт UDP, щоб приймати з’єднання з WireGuard VPN. Тут наш демонстраційний порт UDP — `51820`.

## Увімкнути IP-переадресацію

IP-переадресація дозволяє маршрутизувати пакети між мережами. Це дозволяє внутрішнім пристроям спілкуватися один з одним через тунель WireGuard:

Увімкніть IP-переадресацію для IPv4:

```bash
sudo sysctl -w net.ipv4.ip_forward=1 && sudo sysctl -w net.ipv6.conf.all.forwarding=1
```

## Налаштуйте `firewalld`

Якщо `firewalld` не встановлено, встановіть його:

```bash
sudo dnf install firewalld -y
```

Після встановлення `firewalld` увімкніть його:

```bash
sudo systemctl enable --now firewalld
```

Створіть постійне правило брандмауера, яке дозволяє трафік через UDP-порт 51820 у публічній зоні:

```bash
sudo firewall-cmd --permanent --zone=public --add-port=51820/udp
```

Далі трафік з інтерфейсу WireGuard буде дозволено іншим інтерфейсам у внутрішній зоні.

```bash
sudo firewall-cmd --permanent --add-interface=wg0 --zone=internal
```

Додайте правило брандмауера, щоб увімкнути маскування IP для внутрішнього трафіку. Це означає, що пакети, надіслані між одноранговими вузлами, замінять IP-адресу пакета на IP-адресу сервера:

```bash
sudo firewall-cmd --permanent --zone=internal --add-masquerade
```

Нарешті, перезавантажте `firewalld`:

```bash
sudo firewall-cmd --reload
```

## Налаштуйте вузол WireGuard

Оскільки всі комп’ютери в мережі WireGuard є технічно рівноправними, цей процес майже ідентичний налаштуванню сервера WireGuard, але з деякими невеликими відмінностями.

Створіть папку для зберігання конфігураційних файлів і ключів WireGuard:

```bash
sudo mkdir -p /etc/wireguard
```

Створіть файл конфігурації, вказавши йому назву на свій вибір, яка закінчується розширенням `.conf`:

```bash
sudo touch /etc/wireguard/wg0.conf
```

Створіть нову пару закритого та відкритого ключів:

```bash
wg genkey | sudo tee /etc/wireguard/privatekey | wg pubkey | sudo tee /etc/wireguard/publickey
```

Відредагуйте файл конфігурації за допомогою обраного вами редактора, додавши цей вміст:

```bash
[Interface]
PrivateKey = peer_privatekey
Address = 10.255.255.2/24

[Peer]
PublicKey = server_publickey
AllowedIPs = 10.255.255.1/24
Endpoint = serverip:51820
PersistentKeepalive = 25
```

Замініть `peer_privatekey` на закритий ключ пір, який зберігається в `/etc/wireguard/privatekey` на пірі.

Ви можете використати цю команду, щоб вивести ключ, щоб ви могли його скопіювати:

```bash
sudo cat /etc/wireguard/privatekey
```

Замініть `server_publickey` на відкритий ключ сервера, який зберігається в `/etc/wireguard/publickey` на сервері.

Ви можете використати цю команду, щоб вивести ключ, щоб ви могли його скопіювати:

```bash
sudo cat /etc/wireguard/publickey
```

Замініть `serverip` загальнодоступною IP-адресою сервера WireGuard.

Ви можете знайти публічну IP-адресу сервера за допомогою такої команди на сервері:

```bash
ip a | grep inet
```

Файл конфігурації вузла тепер містить правило `PersistentKeepalive = 25`. Це правило вказує одноранговому вузлу перевіряти сервер WireGuard кожні 25 секунд, щоб підтримувати з’єднання VPN-тунелю. Без цього параметра тунель VPN закінчуватиметься після бездіяльності.

## Додайте ключ клієнта до конфігурації сервера WireGuard

Виведіть відкритий ключ партнера та скопіюйте його:

```bash
sudo cat /etc/wireguard/publickey
```

На сервері виконайте наступну команду, замінивши `peer_publickey` на одноранговий відкритий ключ:

```bash
sudo wg set wg0 peer peer_publickey allowed-ips 10.255.255.2
```

Варто зазначити, що ви можете вручну редагувати та додавати вузли до файлу конфігурації.

## Увімкніть WireGuard VPN

Щоб увімкнути WireGuard, ви запустите таку команду як на сервері, так і на одноранговому пристрої:

```bash
sudo systemctl enable wg-quick@wg0
```

Потім запустіть VPN, виконавши цю команду як на сервері, так і на одноранговому пристрої:

```bash
systemctl start wg-quick@wg0
```

Ви можете переглядати інформацію WireGuard як на сервері, так і на одноранговому пристрої за допомогою:

```bash
sudo wg
```

Ви можете перевірити підключення, надіславши ping на сервер від однорангового пристрою:

```bash
ping 10.255.255.1
```

## Висновок

Дотримуючись цього посібника, ви успішно налаштували WireGuard VPN за допомогою моделі концентратора. Ця конфігурація забезпечує безпечний, сучасний і ефективний спосіб підключення кількох пристроїв через Інтернет. Перегляньте [офіційний веб-сайт WireGuard](https://www.wireguard.com/).
