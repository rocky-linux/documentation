---
title: –ó–º—ñ—Ü–Ω–µ–Ω–Ω—è –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª—ñ–≤ Systemd
author: Julian Patocki
contributors: Steven Spencer
tags:
  - –±–µ–∑–ø–µ–∫–∞
  - systemd
  - –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ
---

## –ü–µ—Ä–µ–¥—É–º–æ–≤–∏

- –ó–Ω–∞–π–æ–º—Å—Ç–≤–æ –∑ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏ –∫–æ–º–∞–Ω–¥–Ω–æ–≥–æ —Ä—è–¥–∫–∞
- –ë–∞–∑–æ–≤–µ —Ä–æ–∑—É–º—ñ–Ω–Ω—è `systemd` —ñ –¥–æ–∑–≤–æ–ª—ñ–≤ –Ω–∞ —Ñ–∞–π–ª–∏
- –£–º—ñ–Ω–Ω—è —á–∏—Ç–∞—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ man

## –í—Å—Ç—É–ø

–ë–∞–≥–∞—Ç–æ —Å–ª—É–∂–± –ø—Ä–∞—Ü—é—é—Ç—å —ñ–∑ –ø—Ä–∏–≤—ñ–ª–µ—è–º–∏, —è–∫—ñ —ó–º –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω—ñ –¥–ª—è –Ω–∞–ª–µ–∂–Ω–æ—ó —Ä–æ–±–æ—Ç–∏. `systemd` –º—ñ—Å—Ç–∏—Ç—å –±–∞–≥–∞—Ç–æ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤, —è–∫—ñ –¥–æ–ø–æ–º–∞–≥–∞—é—Ç—å –º—ñ–Ω—ñ–º—ñ–∑—É–≤–∞—Ç–∏ —Ä–∏–∑–∏–∫, –∫–æ–ª–∏ –ø—Ä–æ—Ü–µ—Å —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–æ–≤–∞–Ω–æ, —à–ª—è—Ö–æ–º –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –∑–∞—Ö–æ–¥—ñ–≤ –±–µ–∑–ø–µ–∫–∏ —Ç–∞ –æ–±–º–µ–∂–µ–Ω–Ω—è –¥–æ–∑–≤–æ–ª—ñ–≤.

## –ó–∞–≤–¥–∞–Ω–Ω—è

- –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è –±–µ–∑–ø–µ–∫–∏ –±–ª–æ–∫—ñ–≤ `systemd`

## –í—ñ–¥–º–æ–≤–∞ –≤—ñ–¥ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–æ—Å—Ç—ñ

–£ —Ü—å–æ–º—É –ø–æ—Å—ñ–±–Ω–∏–∫—É –ø–æ—è—Å–Ω—é—î—Ç—å—Å—è –º–µ—Ö–∞–Ω—ñ–∑–º –∑–∞—Ö–∏—Å—Ç—É –±–ª–æ–∫—ñ–≤ `systemd` —ñ –Ω–µ —Ä–æ–∑–≥–ª—è–¥–∞—î—Ç—å—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –±—É–¥—å-—è–∫–æ–≥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –±–ª–æ–∫—É. –î–µ—è–∫—ñ –ø–æ–Ω—è—Ç—Ç—è –Ω–∞–¥—Ç–æ —Å–ø—Ä–æ—â–µ–Ω—ñ. –†–æ–∑—É–º—ñ–Ω–Ω—è —ó—Ö —ñ –¥–µ—è–∫–∏—Ö –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–Ω–∏—Ö –∫–æ–º–∞–Ω–¥ –≤–∏–º–∞–≥–∞—î –±—ñ–ª—å—à –≥–ª–∏–±–æ–∫–æ–≥–æ –∑–∞–Ω—É—Ä–µ–Ω–Ω—è –≤ —Ç–µ–º—É.

## –†–µ—Å—É—Ä—Å–∏

- [`SYSTEMD.EXEC(5)` man page](https://www.freedesktop.org/software/systemd/man/latest/systemd.exec.html)
- [`Capabilities(7)` man page](https://man7.org/linux/man-pages/man7/capabilities.7.html)

## –ê–Ω–∞–ª—ñ–∑

`systemd` –º—ñ—Å—Ç–∏—Ç—å —á—É–¥–æ–≤–∏–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, —è–∫–∏–π –¥–∞—î —à–≤–∏–¥–∫–∏–π –æ–≥–ª—è–¥ –∑–∞–≥–∞–ª—å–Ω–æ—ó –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó –±–µ–∑–ø–µ–∫–∏ –±–ª–æ–∫—É `systemd`.
`systemd-analyze security` –Ω–∞–¥–∞—î —à–≤–∏–¥–∫–∏–π –æ–≥–ª—è–¥ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó –±–µ–∑–ø–µ–∫–∏ –±–ª–æ–∫—É `systemd`. –û—Å—å –æ—Ü—ñ–Ω–∫–∞ —â–æ–π–Ω–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ–≥–æ `httpd`:

```bash
[user@rocky-vm ~]$ systemd-analyze security httpd
  NAME                                  DESCRIPTION                                                              EXPOSURE
‚úó RootDirectory=/RootImage=             Service runs within the host's root directory                            0.1
  SupplementaryGroups=                  Service runs as root, option does not matter
  RemoveIPC=                            Service runs as root, option does not apply
‚úó User=/DynamicUser=                    Service runs as root user                                                0.4
‚úó CapabilityBoundingSet=~CAP_SYS_TIME   Service processes may change the system clock                            0.2
‚úó NoNewPrivileges=                      Service processes may acquire new privileges                             0.2
...
...
...
‚úì NotifyAccess=                         Service child processes cannot alter service state
‚úì PrivateMounts=                        Service cannot install system mounts
‚úó UMask=                                Files created by service are world-readable by default                   0.1

‚Üí Overall exposure level for httpd.service: 9.2 UNSAFE üò®
```

## –ú–æ–∂–ª–∏–≤–æ—Å—Ç—ñ

–ü–æ–Ω—è—Ç—Ç—è –º–æ–∂–ª–∏–≤–æ—Å—Ç–µ–π –º–æ–∂–µ –±—É—Ç–∏ –¥—É–∂–µ –∑–∞–ø–ª—É—Ç–∞–Ω–∏–º. –†–æ–∑—É–º—ñ–Ω–Ω—è —Ü—å–æ–≥–æ –º–∞—î –≤–∏—Ä—ñ—à–∞–ª—å–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è –¥–ª—è –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –±–µ–∑–ø–µ–∫–∏ –æ–¥–∏–Ω–∏—Ü—å `systemd`. –û—Å—å —É—Ä–∏–≤–æ–∫ –∑—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –¥–æ–≤—ñ–¥–∫–∏ `Capabilities(7)`:

```text
–ó –º–µ—Ç–æ—é –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –¥–æ–∑–≤–æ–ª—ñ–≤ —É —Ç—Ä–∞–¥–∏—Ü—ñ–π–Ω–∏—Ö —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è—Ö UNIX —Ä–æ–∑—Ä—ñ–∑–Ω—è—é—Ç—å –¥–≤—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –ø—Ä–æ—Ü–µ—Å—ñ–≤: –ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω—ñ –ø—Ä–æ—Ü–µ—Å–∏ (—á–∏–π –µ—Ñ–µ–∫—Ç–∏–≤–Ω–∏–π —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–æ—Ä—ñ–≤–Ω—é—î 0, –∑–≤–∞–Ω–∏–π —Å—É–ø–µ—Ä–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º –∞–±–æ root) —ñ –Ω–µ–ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω—ñ –ø—Ä–æ—Ü–µ—Å–∏ (—á–∏–π –µ—Ñ–µ–∫—Ç–∏–≤–Ω–∏–π UID –≤—ñ–¥–º—ñ–Ω–Ω–∏–π –≤—ñ–¥ –Ω—É–ª—è). –ü—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω—ñ –ø—Ä–æ—Ü–µ—Å–∏ –æ–±—Ö–æ–¥—è—Ç—å —É—Å—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –¥–æ–∑–≤–æ–ª—ñ–≤ —è–¥—Ä–∞, —Ç–æ–¥—ñ —è–∫ –Ω–µ–ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω—ñ –ø—Ä–æ—Ü–µ—Å–∏ –ø—ñ–¥–ª—è–≥–∞—é—Ç—å –ø–æ–≤–Ω—ñ–π –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ –¥–æ–∑–≤–æ–ª—ñ–≤ –Ω–∞ –æ—Å–Ω–æ–≤—ñ –æ–±–ª—ñ–∫–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö –ø—Ä–æ—Ü–µ—Å—É (–∑–∞–∑–≤–∏—á–∞–π: –µ—Ñ–µ–∫—Ç–∏–≤–Ω–∏–π UID, –µ—Ñ–µ–∫—Ç–∏–≤–Ω–∏–π GID —ñ —Å–ø–∏—Å–æ–∫ –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö –≥—Ä—É–ø).

–ü–æ—á–∏–Ω–∞—é—á–∏ –∑ Linux 2.2, Linux –¥—ñ–ª–∏—Ç—å –ø—Ä–∏–≤—ñ–ª–µ—ó, —Ç—Ä–∞–¥–∏—Ü—ñ–π–Ω–æ –ø–æ–≤‚Äô—è–∑–∞–Ω—ñ –∑ —Å—É–ø–µ—Ä–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º, –Ω–∞ –æ–∫—Ä–µ–º—ñ –æ–¥–∏–Ω–∏—Ü—ñ, –≤—ñ–¥–æ–º—ñ —è–∫ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ, —è–∫—ñ –º–æ–∂–Ω–∞ –Ω–µ–∑–∞–ª–µ–∂–Ω–æ –≤–º–∏–∫–∞—Ç–∏ —Ç–∞ –≤–∏–º–∏–∫–∞—Ç–∏. –ú–æ–∂–ª–∏–≤–æ—Å—Ç—ñ —î –∞—Ç—Ä–∏–±—É—Ç–æ–º –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –ø–æ—Ç–æ–∫—É.
```

–¶–µ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º—É –æ–∑–Ω–∞—á–∞—î, —â–æ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –º–æ–∂—É—Ç—å –Ω–∞–¥–∞–≤–∞—Ç–∏ –¥–µ—è–∫—ñ –ø—Ä–∏–≤—ñ–ª–µ—ó `root` –Ω–µ–ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–∏–º –ø—Ä–æ—Ü–µ—Å–∞–º, –∞–ª–µ —Ç–∞–∫–æ–∂ –æ–±–º–µ–∂—É–≤–∞—Ç–∏ –ø—Ä–∏–≤—ñ–ª–µ—ó –ø—Ä–æ—Ü–µ—Å—ñ–≤, —è–∫—ñ –∑–∞–ø—É—Å–∫–∞—é—Ç—å—Å—è `root`.

–ó–∞—Ä–∞–∑ —ñ—Å–Ω—É—î 41 –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å. –¶–µ –æ–∑–Ω–∞—á–∞—î, —â–æ –ø—Ä–∏–≤—ñ–ª–µ—ó `root` –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –º–∞—é—Ç—å 41 –Ω–∞–±—ñ—Ä –ø—Ä–∏–≤—ñ–ª–µ—ó–≤. –û—Å—å –∫—ñ–ª—å–∫–∞ –ø—Ä–∏–∫–ª–∞–¥—ñ–≤:

- **CAP_CHOWN**: –í–Ω–æ—Å–∏—Ç—å –¥–æ–≤—ñ–ª—å–Ω—ñ –∑–º—ñ–Ω–∏ –≤ UID —Ç–∞ GID —Ñ–∞–π–ª—ñ–≤
- **CAP_KILL**: –û–±—Ö–æ–¥–∏—Ç—å –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –¥–æ–∑–≤–æ–ª—ñ–≤ –¥–ª—è –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è —Å–∏–≥–Ω–∞–ª—ñ–≤
- **CAP_NET_BIND_SERVICE**: –ü—Ä–∏–≤‚Äô—è–∑—É—î —Å–æ–∫–µ—Ç –¥–æ –ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–∏—Ö –ø–æ—Ä—Ç—ñ–≤ –Ü–Ω—Ç–µ—Ä–Ω–µ—Ç-–¥–æ–º–µ–Ω—É (–Ω–æ–º–µ—Ä–∞ –ø–æ—Ä—Ç—ñ–≤ –º–µ–Ω—à–µ 1024)

–°—Ç–æ—Ä—ñ–Ω–∫–∞ –¥–æ–≤—ñ–¥–∫–∏ `Capabilities(7)` –º—ñ—Å—Ç–∏—Ç—å –ø–æ–≤–Ω–∏–π —Å–ø–∏—Å–æ–∫.

–Ñ –¥–≤–∞ —Ç–∏–ø–∏ –º–æ–∂–ª–∏–≤–æ—Å—Ç–µ–π:

- –ú–æ–∂–ª–∏–≤–æ—Å—Ç—ñ —Ñ–∞–π–ª—ñ–≤
- –ú–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –ø–æ—Ç–æ–∫—É

## –ú–æ–∂–ª–∏–≤–æ—Å—Ç—ñ —Ñ–∞–π–ª—ñ–≤

–ú–æ–∂–ª–∏–≤–æ—Å—Ç—ñ —Ñ–∞–π–ª—ñ–≤ –¥–æ–∑–≤–æ–ª—è—é—Ç—å –∞—Å–æ—Ü—ñ—é–≤–∞—Ç–∏ –ø—Ä–∏–≤—ñ–ª–µ—ó –∑ –≤–∏–∫–æ–Ω—É–≤–∞–Ω–∏–º —Ñ–∞–π–ª–æ–º, –ø–æ–¥—ñ–±–Ω–æ –¥–æ `suid`. –í–æ–Ω–∏ –≤–∫–ª—é—á–∞—é—Ç—å —Ç—Ä–∏ –Ω–∞–±–æ—Ä–∏, —â–æ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ —Ä–æ–∑—à–∏—Ä–µ–Ω–æ–º—É –∞—Ç—Ä–∏–±—É—Ç—ñ: `Permitted`, `Inheritable`, and `Effective`.

–ó–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –¥–æ–≤—ñ–¥–∫–∏ `Capabilities(7)` –¥–ª—è –ø–æ–≤–Ω–æ–≥–æ –ø–æ—è—Å–Ω–µ–Ω–Ω—è.

–ú–æ–∂–ª–∏–≤–æ—Å—Ç—ñ —Ñ–∞–π–ª—ñ–≤ –Ω–µ –º–æ–∂—É—Ç—å –≤–ø–ª–∏–Ω—É—Ç–∏ –Ω–∞ –∑–∞–≥–∞–ª—å–Ω–∏–π —Ä—ñ–≤–µ–Ω—å –µ–∫—Å–ø–æ–∑–∏—Ü—ñ—ó –ø—Ä–∏—Å—Ç—Ä–æ—é, —Ç–æ–º—É –≤–æ–Ω–∏ –ª–∏—à–µ –Ω–µ–∑–Ω–∞—á–Ω–æ —Å—Ç–æ—Å—É—é—Ç—å—Å—è —Ü—å–æ–≥–æ –ø–æ—Å—ñ–±–Ω–∏–∫–∞. –û–¥–Ω–∞–∫ —Ä–æ–∑—É–º—ñ–Ω–Ω—è —ó—Ö –º–æ–∂–µ –±—É—Ç–∏ –∫–æ—Ä–∏—Å–Ω–∏–º. –¢–æ–º—É –∫–æ—Ä–æ—Ç–∫–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—è:

–î–∞–≤–∞–π—Ç–µ —Å–ø—Ä–æ–±—É—î–º–æ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ `httpd` –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É (–ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–æ–º—É) –ø–æ—Ä—Ç—É 80 —è–∫ –Ω–µ–ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á:

```bash
[user@rocky-vm ~]$ sudo -u apache /usr/sbin/httpd
(13)Permission denied: AH00072: make_sock: could not bind to address 0.0.0.0:80
no listening sockets available, shutting down
```

–Ø–∫ —ñ –æ—á—ñ–∫—É–≤–∞–ª–æ—Å—è, –æ–ø–µ—Ä–∞—Ü—ñ—è –Ω–µ –≤–¥–∞—î—Ç—å—Å—è. –î–∞–≤–∞–π—Ç–µ –æ—Å–Ω–∞—Å—Ç–∏–º–æ –¥–≤—ñ–π–∫–æ–≤–∏–π —Ñ–∞–π–ª `httpd` –∑–≥–∞–¥–∞–Ω–∏–º–∏ —Ä–∞–Ω—ñ—à–µ **CAP_NET_BIND_SERVICE** —ñ **CAP_DAC_OVERRIDE** (—â–æ–± –∑–∞–º—ñ–Ω–∏—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –¥–æ–∑–≤–æ–ª—ñ–≤ –Ω–∞ —Ñ–∞–π–ª–∏ log —ñ pid –¥–ª—è —Ü—ñ—î—ó –≤–ø—Ä–∞–≤–∏) —ñ —Å–ø—Ä–æ–±—É—î–º–æ —â–µ —Ä–∞–∑:

```bash
[user@rocky-vm ~]$ sudo setcap "cap_net_bind_service=+ep cap_dac_override=+ep" /usr/sbin/httpd
[user@rocky-vm ~]$ sudo -u apache /usr/sbin/httpd
[user@rocky-vm ~]$ curl --head localhost
HTTP/1.1 403 Forbidden
...
```

–Ø–∫ —ñ –æ—á—ñ–∫—É–≤–∞–ª–æ—Å—è, –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –≤–¥–∞–ª–æ—Å—è —É—Å–ø—ñ—à–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç–∏.

## –ú–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –ø–æ—Ç–æ–∫—É

–ú–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –ø–æ—Ç–æ–∫—É –∑–∞—Å—Ç–æ—Å–æ–≤—É—é—Ç—å—Å—è –¥–æ –ø—Ä–æ—Ü–µ—Å—É —Ç–∞ –π–æ–≥–æ –¥—ñ—Ç–µ–π. –Ü—Å–Ω—É—î –ø'—è—Ç—å –Ω–∞–±–æ—Ä—ñ–≤ –º–æ–∂–ª–∏–≤–æ—Å—Ç–µ–π –ø–æ—Ç–æ–∫—É:

- Permitted
- Inheritable
- Effective
- Bounding
- Ambient

–©–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ–≤–Ω–µ –ø–æ—è—Å–Ω–µ–Ω–Ω—è, –∑–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –¥–æ–≤—ñ–¥–∫–∏ `Capabilities(7)`.

–í–∏ –≤–∂–µ –≤—Å—Ç–∞–Ω–æ–≤–∏–ª–∏, —â–æ `httpd` –Ω–µ –ø–æ—Ç—Ä–µ–±—É—î –≤—Å—ñ—Ö –ø—Ä–∏–≤—ñ–ª–µ—ó–≤, –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–≤—ñ `root`. –î–∞–≤–∞–π—Ç–µ –≤–∏–¥–∞–ª–∏–º–æ —Ä–∞–Ω—ñ—à–µ –Ω–∞–¥–∞–Ω—ñ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –∑ –¥–≤—ñ–π–∫–æ–≤–æ–≥–æ —Ñ–∞–π–ª—É `httpd`, –∑–∞–ø—É—Å—Ç–∏–º–æ –¥–µ–º–æ–Ω `httpd` —ñ –ø–µ—Ä–µ–≤—ñ—Ä–∏–º–æ –π–æ–≥–æ –ø—Ä–∏–≤—ñ–ª–µ—ó:

```bash
[user@rocky-vm ~]$ sudo setcap -r /usr/sbin/httpd
[user@rocky-vm ~]$ sudo systemctl start httpd
[user@rocky-vm ~]$ grep Cap /proc/$(pgrep --uid 0 httpd)/status
CapInh: 0000000000000000
CapPrm: 000001ffffffffff
CapEff: 000001ffffffffff
CapBnd: 000001ffffffffff
CapAmb: 0000000000000000
[user@rocky-vm ~]$ capsh --decode=000001ffffffffff
0x000001ffffffffff=cap_chown,cap_dac_override,cap_dac_read_search,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_linux_immutable,cap_net_bind_service,cap_net_broadcast,cap_net_admin,cap_net_raw,cap_ipc_lock,cap_ipc_owner,cap_sys_module,cap_sys_rawio,cap_sys_chroot,cap_sys_ptrace,cap_sys_pacct,cap_sys_admin,cap_sys_boot,cap_sys_nice,cap_sys_resource,cap_sys_time,cap_sys_tty_config,cap_mknod,cap_lease,cap_audit_write,cap_audit_control,cap_setfcap,cap_mac_override,cap_mac_admin,cap_syslog,cap_wake_alarm,cap_block_suspend,cap_audit_read,cap_perfmon,cap_bpf,cap_checkpoint_restore
```

–û—Å–Ω–æ–≤–Ω–∏–π –ø—Ä–æ—Ü–µ—Å `httpd` –ø—Ä–∞—Ü—é—î –∑ —É—Å—ñ–º–∞ –¥–æ—Å—Ç—É–ø–Ω–∏–º–∏ –º–æ–∂–ª–∏–≤–æ—Å—Ç—è–º–∏, —Ö–æ—á–∞ –±—ñ–ª—å—à—ñ—Å—Ç—å —ñ–∑ –Ω–∏—Ö –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω—ñ.

## –û–±–º–µ–∂–µ–Ω–Ω—è –º–æ–∂–ª–∏–≤–æ—Å—Ç–µ–π

`systemd` –∑–º–µ–Ω—à—É—î –Ω–∞–±–æ—Ä–∏ –º–æ–∂–ª–∏–≤–æ—Å—Ç–µ–π –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ:

- **CapabilityBoundingSet**: –æ–±–º–µ–∂—É—î –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ, –æ—Ç—Ä–∏–º–∞–Ω—ñ –ø—ñ–¥ —á–∞—Å `execve`
- **AmbientCapabilities**: –∫–æ—Ä–∏—Å–Ω–∏–π, —è–∫—â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –≤–∏–∫–æ–Ω–∞—Ç–∏ –ø—Ä–æ—Ü–µ—Å —è–∫ –Ω–µ–ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á, –∞–ª–µ –≤—Å–µ –∂ —Ö–æ—á–µ—Ç–µ –Ω–∞–¥–∞—Ç–∏ –π–æ–º—É –¥–µ—è–∫—ñ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ

–©–æ–± –∑–±–µ—Ä–µ–≥—Ç–∏ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é –Ω–∞–¥ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è–º–∏ –ø–∞–∫–µ—Ç—ñ–≤, —Å—Ç–≤–æ—Ä—ñ—Ç—å —Ñ–∞–π–ª `override.conf` —É –∫–∞—Ç–∞–ª–æ–∑—ñ `/lib/systemd/system/httpd.service.d/`.

–ó–Ω–∞—é—á–∏, —â–æ —Å–ª—É–∂–±—ñ –ø–æ—Ç—Ä—ñ–±–µ–Ω –¥–æ—Å—Ç—É–ø –¥–æ –ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–æ–≥–æ –ø–æ—Ä—Ç—É —Ç–∞ –≤–æ–Ω–∞ –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è —è–∫ `root`, –∞–ª–µ —Ä–æ–∑–≥–∞–ª—É–∂—É—î —Å–≤–æ—ó –ø–æ—Ç–æ–∫–∏ —è–∫ `apache`, –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ –≤–∫–∞–∑–∞—Ç–∏ —Ç–∞–∫—ñ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –≤ —Ä–æ–∑–¥—ñ–ª—ñ `[Service]` `/lib/ —Ñ–∞–π–ª systemd/system/httpd.service.d/override.conf`:

```bash
[Service]
CapabilityBoundingSet=CAP_NET_BIND_SERVICE CAP_SETUID CAP_SETGID
```

–ú–æ–∂–ª–∏–≤–µ –∑–Ω–∏–∂–µ–Ω–Ω—è –∑–∞–≥–∞–ª—å–Ω–æ–≥–æ —Ä—ñ–≤–Ω—è –≤–ø–ª–∏–≤—É –≤—ñ–¥ "–ù–ï–ë–ï–ó–ü–ï–ß–ù–û" –¥–æ "–°–ï–†–ï–î–ù–¨–û–ì–û".

```bash
[user@rocky-vm ~]$ sudo systemctl daemon-reload
[user@rocky-vm ~]$ sudo systemctl restart httpd
[user@rocky-vm ~]$ systemd-analyze security --no-pager httpd | grep Overall
‚Üí Overall exposure level for httpd.service: 7.1 MEDIUM üòê
```

–û–¥–Ω–∞–∫ —Ü–µ–π –ø—Ä–æ—Ü–µ—Å –≤—Å–µ —â–µ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è —è–∫ `root`. –ú–æ–∂–ª–∏–≤–µ –ø–æ–¥–∞–ª—å—à–µ –∑–Ω–∏–∂–µ–Ω–Ω—è —Ä—ñ–≤–Ω—è –µ–∫—Å–ø–æ–∑–∏—Ü—ñ—ó, –∑–∞–ø—É—Å—Ç–∏–≤—à–∏ –π–æ–≥–æ –≤–∏–∫–ª—é—á–Ω–æ —è–∫ `apache`.

–ö—Ä—ñ–º –¥–æ—Å—Ç—É–ø—É –¥–æ –ø–æ—Ä—Ç—É 80, –ø—Ä–æ—Ü–µ—Å –ø–æ–≤–∏–Ω–µ–Ω –ø–∏—Å–∞—Ç–∏ –≤ –∂—É—Ä–Ω–∞–ª–∏, —Ä–æ–∑—Ç–∞—à–æ–≤–∞–Ω—ñ –≤ `/etc/httpd/logs/`, —ñ –º–∞—Ç–∏ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å —Å—Ç–≤–æ—Ä–∏—Ç–∏ `/run/httpd/` —ñ –ø–∏—Å–∞—Ç–∏ –≤ –Ω—å–æ–≥–æ. –£ –ø–µ—Ä—à–æ–º—É –≤–∏ –º–æ–∂–µ—Ç–µ –¥–æ—Å—è–≥—Ç–∏ —Ü—å–æ–≥–æ, –∑–º—ñ–Ω–∏–≤—à–∏ –¥–æ–∑–≤–æ–ª–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `chown`, –∞ –≤ –¥—Ä—É–≥–æ–º—É –≤–∏ –º–æ–∂–µ—Ç–µ —Å–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏—Å—è —É—Ç–∏–ª—ñ—Ç–æ—é `systemd-tmpfiles`. –í–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –π–æ–≥–æ –∑ –æ–ø—Ü—ñ—î—é `--create`, —â–æ–± —Å—Ç–≤–æ—Ä–∏—Ç–∏ —Ñ–∞–π–ª –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è, –∞–ª–µ –≤—ñ–¥—Ç–µ–ø–µ—Ä –≤—ñ–Ω —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏–º–µ—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—ñ–¥ —á–∞—Å –∫–æ–∂–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫—É —Å–∏—Å—Ç–µ–º–∏.

```bash
[user@rocky-vm ~]$ sudo chown -R apache:apache /etc/httpd/logs/
[user@rocky-vm ~]$ echo 'd /run/httpd 0755 apache apache -' | sudo tee /etc/tmpfiles.d/httpd.conf
d /run/httpd 0755 apache apache -
[user@rocky-vm ~]$ sudo systemd-tmpfiles --create /etc/tmpfiles.d/httpd.conf
[user@rocky-vm ~]$ ls -ld /run/httpd/
drwxr-xr-x. 2 apache apache 40 Jun 30 08:29 /run/httpd/
```

–í–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é –≤ `/lib/systemd/system/httpd.service.d/override.conf`. –í–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –Ω–∞–¥–∞—Ç–∏ –Ω–æ–≤—ñ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é **AmbientCapabilities**. –Ø–∫—â–æ `httpd` —É–≤—ñ–º–∫–Ω–µ–Ω–æ –ø—ñ–¥ —á–∞—Å –∑–∞–ø—É—Å–∫—É, —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π —É —Ä–æ–∑–¥—ñ–ª—ñ `[Unit]` –º–∞—î –≤—ñ–¥–±—É—Ç–∏—Å—è, —â–æ–± —Å–ª—É–∂–±–∞ –∑–∞–ø—É—Å—Ç–∏–ª–∞—Å—è –ø—ñ—Å–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∏–º—á–∞—Å–æ–≤–æ–≥–æ —Ñ–∞–π–ª—É.

```bash
[Unit]
After=systemd-tmpfiles-setup.service

[Service]
User=apache
CapabilityBoundingSet=CAP_NET_BIND_SERVICE
AmbientCapabilities=CAP_NET_BIND_SERVICE
```

```bash
[user@rocky-vm ~]$ sudo systemctl daemon-reload
[user@rocky-vm ~]$ sudo systemctl restart httpd
[user@rocky-vm ~]$ grep Cap /proc/$(pgrep httpd | head -1)/status
CapInh: 0000000000000400
CapPrm: 0000000000000400
CapEff: 0000000000000400
CapBnd: 0000000000000400
CapAmb: 0000000000000400
[user@rocky-vm ~]$ capsh --decode=0000000000000400
0x0000000000000400=cap_net_bind_service
[user@rocky-vm ~]$ systemd-analyze security --no-pager httpd | grep Overall
‚Üí Overall exposure level for httpd.service: 6.5 MEDIUM üòê
```

## –û–±–º–µ–∂–µ–Ω–Ω—è —Ñ–∞–π–ª–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏

–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –¥–æ–∑–≤–æ–ª–∞–º–∏ –Ω–∞ —Ñ–∞–π–ª–∏, —è–∫—ñ —Å—Ç–≤–æ—Ä—é—î –ø—Ä–æ—Ü–µ—Å, –∑–¥—ñ–π—Å–Ω—é—î—Ç—å—Å—è —à–ª—è—Ö–æ–º –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è `UMask`.
–ü–∞—Ä–∞–º–µ—Ç—Ä `UMask` –∑–º—ñ–Ω—é—î –¥–æ–∑–≤–æ–ª–∏ –Ω–∞ —Ñ–∞–π–ª –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º, –≤–∏–∫–æ–Ω—É—é—á–∏ –ø–æ–±—ñ—Ç–æ–≤—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó. –¶–µ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º—É –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î –¥–æ–∑–≤–æ–ª–∏ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –Ω–∞ –≤—ñ—Å—ñ–º–∫–æ–≤–∏–π `0644` (`-rw-r--r--`), –∞ `UMask` –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º - `0022`. –¶–µ –æ–∑–Ω–∞—á–∞—î, —â–æ `UMask` –Ω–µ –∑–º—ñ–Ω—é—î –Ω–∞–±—ñ—Ä –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º:

```bash
[user@rocky-vm ~]$ printf "%o\n" $(echo $(( 00644 &  ~00022 )))
644
```

–Ø–∫—â–æ –ø—Ä–∏–ø—É—Å—Ç–∏—Ç–∏, —â–æ –±–∞–∂–∞–Ω–∏–º –Ω–∞–±–æ—Ä–æ–º –¥–æ–∑–≤–æ–ª—ñ–≤ –¥–ª—è —Ñ–∞–π–ª—ñ–≤, —Å—Ç–≤–æ—Ä–µ–Ω–∏—Ö –¥–µ–º–æ–Ω–æ–º, —î `0640` (`-rw-r-----`), –≤–∏ –º–æ–∂–µ—Ç–µ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –¥–ª—è `UMask` –∑–Ω–∞—á–µ–Ω–Ω—è `7137`. –¶–µ –¥–æ—Å—è–≥–∞—î –º–µ—Ç–∏, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –¥–æ–∑–≤–æ–ª–∏ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ –Ω–∞ `7777`:

```bash
[user@rocky-vm ~]$ printf "%o\n" $(echo $(( 07777 &  ~07137  )))
640
```

–ö—Ä—ñ–º —Ç–æ–≥–æ:

- `ProtectSystem=`: _"–Ø–∫—â–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∑–Ω–∞—á–µ–Ω–Ω—è "`strict`", —É—Å—è —ñ—î—Ä–∞—Ä—Ö—ñ—è —Ñ–∞–π–ª–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏ –º–æ–Ω—Ç—É—î—Ç—å—Å—è –ª–∏—à–µ –¥–ª—è —á–∏—Ç–∞–Ω–Ω—è, –∑–∞ –≤–∏–Ω—è—Ç–∫–æ–º –ø—ñ–¥–¥–µ—Ä–µ–≤ —Ñ–∞–π–ª–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏ API `/dev/`, `/proc/` —Ç–∞ `/sys/` (–∑–∞—Ö–∏—Å—Ç—ñ—Ç—å —Ü—ñ –∫–∞—Ç–∞–ª–æ–≥–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `PrivateDevices=`, `ProtectKernelTunables=`, `ProtectControlGroups=`)."_
- `ReadWritePaths=`: –∑–Ω–æ–≤—É —Ä–æ–±–∏—Ç—å –æ–∫—Ä–µ–º—ñ —à–ª—è—Ö–∏ –¥–æ—Å—Ç—É–ø–Ω–∏–º–∏ –¥–ª—è –∑–∞–ø–∏—Å—É
- `ProtectHome=`: —Ä–æ–±–∏—Ç—å `/home/`, `/root` —ñ `/run/user` –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–º–∏
- `PrivateDevices=`: –≤–∏–º–∏–∫–∞—î –¥–æ—Å—Ç—É–ø –¥–æ —Ñ—ñ–∑–∏—á–Ω–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤, –¥–æ–∑–≤–æ–ª—è—î –¥–æ—Å—Ç—É–ø –ª–∏—à–µ –¥–æ –ø—Å–µ–≤–¥–æ–ø—Ä–∏—Å—Ç—Ä–æ—ó–≤, —Ç–∞–∫–∏—Ö —è–∫ `/dev/null`, `/dev/zero`, `/dev/random`
- `ProtectKernelTunables=`: —Ä–æ–±–∏—Ç—å `/proc/` —ñ `/sys/` –¥–æ—Å—Ç—É–ø–Ω–∏–º–∏ –ª–∏—à–µ –¥–ª—è —á–∏—Ç–∞–Ω–Ω—è
- `ProtectControlGroups=`: —Ä–æ–±–∏—Ç—å `cgroups` –¥–æ—Å—Ç—É–ø–Ω–∏–º–∏ –ª–∏—à–µ –¥–ª—è —á–∏—Ç–∞–Ω–Ω—è
- `ProtectKernelModules=`: –∑–∞–±–æ—Ä–æ–Ω—è—î —è–≤–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–¥—É–ª—è
- `ProtectKernelLogs=`: –æ–±–º–µ–∂—É—î –¥–æ—Å—Ç—É–ø –¥–æ –±—É—Ñ–µ—Ä–∞ –∂—É—Ä–Ω–∞–ª—É —è–¥—Ä–∞
- `ProtectProc=`: _"–Ø–∫—â–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∑–Ω–∞—á–µ–Ω–Ω—è ¬´–Ω–µ–≤–∏–¥–∏–º–∏–π¬ª, –ø—Ä–æ—Ü–µ—Å–∏, —â–æ –Ω–∞–ª–µ–∂–∞—Ç—å —ñ–Ω—à–∏–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º, –ø—Ä–∏—Ö–æ–≤–∞–Ω—ñ –≤—ñ–¥ /proc/."_
- `ProcSubset=`: _"–Ø–∫—â–æ ¬´pid¬ª, —É—Å—ñ —Ñ–∞–π–ª–∏ —Ç–∞ –∫–∞—Ç–∞–ª–æ–≥–∏, —è–∫—ñ –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –Ω–µ –ø–æ–≤‚Äô—è–∑–∞–Ω—ñ –∑ –∫–µ—Ä—É–≤–∞–Ω–Ω—è–º –ø—Ä–æ—Ü–µ—Å–∞–º–∏ —Ç–∞ —Å–∞–º–æ–∞–Ω–∞–ª—ñ–∑–æ–º, —Å—Ç–∞—é—Ç—å –Ω–µ–≤–∏–¥–∏–º–∏–º–∏ —É —Ñ–∞–π–ª–æ–≤—ñ–π —Å–∏—Å—Ç–µ–º—ñ /proc/, –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω—ñ–π –¥–ª—è –ø—Ä–æ—Ü–µ—Å—ñ–≤ –ø—Ä–∏—Å—Ç—Ä–æ—é."_

–¢–∞–∫–æ–∂ –º–æ–∂–ª–∏–≤–æ –æ–±–º–µ–∂–∏—Ç–∏ —à–ª—è—Ö–∏ –¥–æ –≤–∏–∫–æ–Ω—É–≤–∞–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤. –î–µ–º–æ–Ω—É –ø–æ—Ç—Ä—ñ–±–Ω–æ –ª–∏—à–µ –≤–∏–∫–æ–Ω–∞—Ç–∏ —Å–≤–æ—ó –¥–≤—ñ–π–∫–æ–≤—ñ —Ñ–∞–π–ª–∏ —Ç–∞ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏. –£—Ç–∏–ª—ñ—Ç–∞ `ldd` –º–æ–∂–µ —Å–∫–∞–∑–∞—Ç–∏ –Ω–∞–º, —è–∫—ñ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –¥–≤—ñ–π–∫–æ–≤–∏–π —Ñ–∞–π–ª:

```bash
[user@rocky-vm ~]$ ldd /usr/sbin/httpd
        linux-vdso.so.1 (0x00007ffc0e823000)
        libpcre.so.1 => /lib64/libpcre.so.1 (0x00007fa360d61000)
        libselinux.so.1 => /lib64/libselinux.so.1 (0x00007fa360d34000)
        libaprutil-1.so.0 => /lib64/libaprutil-1.so.0 (0x00007fa360d05000)
        libcrypt.so.2 => /lib64/libcrypt.so.2 (0x00007fa360ccb000)
        libexpat.so.1 => /lib64/libexpat.so.1 (0x00007fa360c9a000)
        libapr-1.so.0 => /lib64/libapr-1.so.0 (0x00007fa360c5a000)
        libc.so.6 => /lib64/libc.so.6 (0x00007fa360a00000)
        libpcre2-8.so.0 => /lib64/libpcre2-8.so.0 (0x00007fa360964000)
        /lib64/ld-linux-x86-64.so.2 (0x00007fa360e70000)
        libuuid.so.1 => /lib64/libuuid.so.1 (0x00007fa360c4e000)
        libm.so.6 => /lib64/libm.so.6 (0x00007fa360889000)
```

–ù–∞—Å—Ç—É–ø–Ω—ñ —Ä—è–¥–∫–∏ –±—É–¥–µ –¥–æ–¥–∞–Ω–æ –¥–æ —Ä–æ–∑–¥—ñ–ª—É `[Service]` —É —Ñ–∞–π–ª—ñ `override.conf`:

```bash
UMask=7177
ProtectSystem=strict
ReadWritePaths=/run/httpd /etc/httpd/logs

ProtectHome=true
PrivateDevices=true
ProtectKernelTunables=true
ProtectControlGroups=true
ProtectKernelModules=true
ProtectKernelLogs=true
ProtectProc=invisible
ProcSubset=pid

NoExecPaths=/
ExecPaths=/usr/sbin/httpd /lib64
```

–ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏–º–æ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∏–º–æ –≤–ø–ª–∏–≤ –Ω–∞ —Ä–∞—Ö—É–Ω–æ–∫:

```bash
[user@rocky-vm ~]$ sudo systemctl daemon-reload
[user@rocky-vm ~]$ sudo systemctl restart httpd
[user@rocky-vm ~]$ systemd-analyze security --no-pager httpd | grep Overall
‚Üí Overall exposure level for httpd.service: 4.9 OK üôÇ
```

## –°–∏—Å—Ç–µ–º–Ω—ñ –æ–±–º–µ–∂–µ–Ω–Ω—è

–†—ñ–∑–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –º–æ–∂—É—Ç—å –æ–±–º–µ–∂—É–≤–∞—Ç–∏ —Ä–æ–±–æ—Ç—É —Å–∏—Å—Ç–µ–º–∏ –¥–ª—è –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –±–µ–∑–ø–µ–∫–∏:

- `NoNewPrivileges=`: –≥–∞—Ä–∞–Ω—Ç—É—î, —â–æ –ø—Ä–æ—Ü–µ—Å –Ω–µ –º–æ–∂–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –Ω–æ–≤—ñ –ø—Ä–∏–≤—ñ–ª–µ—ó —á–µ—Ä–µ–∑ –±—ñ—Ç–∏ `setuid`, `setgid` —ñ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ —Ñ–∞–π–ª–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏
- `ProtectClock=`: –∑–∞–±–æ—Ä–æ–Ω—è—î –∑–∞–ø–∏—Å –¥–æ —Å–∏—Å—Ç–µ–º–Ω–∏—Ö —ñ –∞–ø–∞—Ä–∞—Ç–Ω–∏—Ö –≥–æ–¥–∏–Ω–Ω–∏–∫—ñ–≤
- `SystemCallArchitectures=`: —è–∫—â–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∑–Ω–∞—á–µ–Ω–Ω—è `native`, –ø—Ä–æ—Ü–µ—Å–∏ –º–æ–∂—É—Ç—å –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –ª–∏—à–µ –≤–ª–∞—Å–Ω—ñ `—Å–∏—Å—Ç–µ–º–Ω—ñ –≤–∏–∫–ª–∏–∫–∏` (—É –±—ñ–ª—å—à–æ—Å—Ç—ñ –≤–∏–ø–∞–¥–∫—ñ–≤ `x86-64`)
- `RestrictNamespaces=`: –ø—Ä–æ—Å—Ç–æ—Ä–∏ —ñ–º–µ–Ω –∑–¥–µ–±—ñ–ª—å—à–æ–≥–æ —Å—Ç–æ—Å—É—é—Ç—å—Å—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤, —Ç–æ–º—É —ó—Ö –º–æ–∂–Ω–∞ –æ–±–º–µ–∂–∏—Ç–∏ –¥–ª—è —Ü—å–æ–≥–æ –±–ª–æ–∫—É
- `RestrictSUIDSGID=`: –Ω–µ –¥–æ–∑–≤–æ–ª—è—î –ø—Ä–æ—Ü–µ—Å—É –≤—Å—Ç–∞–Ω–æ–≤–ª—é–≤–∞—Ç–∏ –±—ñ—Ç–∏ `setuid` —ñ `setgid` –¥–ª—è —Ñ–∞–π–ª—ñ–≤
- `LockPersonality=`: –∑–∞–ø–æ–±—ñ–≥–∞—î –∑–º—ñ–Ω—ñ –¥–æ–º–µ–Ω—É –≤–∏–∫–æ–Ω–∞–Ω–Ω—è, —â–æ –º–æ–∂–µ –±—É—Ç–∏ –∫–æ—Ä–∏—Å–Ω–∏–º –ª–∏—à–µ –¥–ª—è –∑–∞–ø—É—Å–∫—É –∑–∞—Å—Ç–∞—Ä—ñ–ª–∏—Ö –ø—Ä–æ–≥—Ä–∞–º –∞–±–æ –ø—Ä–æ–≥—Ä–∞–º–Ω–æ–≥–æ –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è, —Ä–æ–∑—Ä–æ–±–ª–µ–Ω–æ–≥–æ –¥–ª—è —ñ–Ω—à–∏—Ö Unix-–ø–æ–¥—ñ–±–Ω–∏—Ö —Å–∏—Å—Ç–µ–º
- `RestrictRealtime=`: –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ –∞–∫—Ç—É–∞–ª—å–Ω–µ –ª–∏—à–µ –¥–ª—è –¥–æ–¥–∞—Ç–∫—ñ–≤, —è–∫—ñ –≤–∏–º–∞–≥–∞—é—Ç—å —Å—É–≤–æ—Ä–∏—Ö –≥–∞—Ä–∞–Ω—Ç—ñ–π —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó, —Ç–∞–∫–∏—Ö —è–∫ –ø—Ä–æ–º–∏—Å–ª–æ–≤—ñ —Å–∏—Å—Ç–µ–º–∏ –∫–µ—Ä—É–≤–∞–Ω–Ω—è, –æ–±—Ä–æ–±–∫–∞ –∞—É–¥—ñ–æ/–≤—ñ–¥–µ–æ —Ç–∞ –Ω–∞—É–∫–æ–≤–µ –º–æ–¥–µ–ª—é–≤–∞–Ω–Ω—è
- `RestrictAddressFamilies=`: –æ–±–º–µ–∂—É—î –¥–æ—Å—Ç—É–ø–Ω—ñ —Å—ñ–º–µ–π—Å—Ç–≤–∞ –∞–¥—Ä–µ—Å —Å–æ–∫–µ—Ç—ñ–≤; –º–æ–∂–Ω–∞ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –∑–Ω–∞—á–µ–Ω–Ω—è `AF_(INET|INET6)`, —â–æ–± –¥–æ–∑–≤–æ–ª–∏—Ç–∏ –ª–∏—à–µ —Å–æ–∫–µ—Ç–∏ IPv4 —Ç–∞ IPv6; –¥–µ—è–∫–∏–º —Å–ª—É–∂–±–∞–º –∑–Ω–∞–¥–æ–±–∏—Ç—å—Å—è `AF_UNIX` –¥–ª—è –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ–≥–æ –∑–≤'—è–∑–∫—É —Ç–∞ –∂—É—Ä–Ω–∞–ª—é–≤–∞–Ω–Ω—è
- `MemoryDenyWriteExecute=`: –≥–∞—Ä–∞–Ω—Ç—É—î, —â–æ –ø—Ä–æ—Ü–µ—Å –Ω–µ –∑–º–æ–∂–µ –≤–∏–¥—ñ–ª—è—Ç–∏ –Ω–æ–≤—ñ –æ–±–ª–∞—Å—Ç—ñ –ø–∞–º‚Äô—è—Ç—ñ, —è–∫—ñ –¥–æ—Å—Ç—É–ø–Ω—ñ —è–∫ –¥–ª—è –∑–∞–ø–∏—Å—É, —Ç–∞–∫ —ñ –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è, –∑–∞–ø–æ–±—ñ–≥–∞—î –¥–µ—è–∫–∏–º —Ç–∏–ø–∞–º –∞—Ç–∞–∫, –∫–æ–ª–∏ —à–∫—ñ–¥–ª–∏–≤–∏–π –∫–æ–¥ –≤—Å—Ç–∞–≤–ª—è—î—Ç—å—Å—è –≤ –ø–∞–º‚Äô—è—Ç—å –¥–ª—è –∑–∞–ø–∏—Å—É, –∞ –ø–æ—Ç—ñ–º –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è; –º–æ–∂–µ –ø—Ä–∏–∑–≤–µ—Å—Ç–∏ –¥–æ –∑–±–æ—é –∫–æ–º–ø—ñ–ª—è—Ç–æ—Ä—ñ–≤ JIT, —è–∫—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è JavaScript, Java –∞–±–æ .NET
- `ProtectHostname=`: –∑–∞–ø–æ–±—ñ–≥–∞—î –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—é –ø—Ä–æ—Ü–µ—Å–æ–º `syscalls` `sethostname()`, `setdomainname()`

–î–∞–≤–∞–π—Ç–µ –¥–æ–¥–∞–º–æ –Ω–∞—Å—Ç—É–ø–Ω–µ –¥–æ —Ñ–∞–π–ª—É `override.conf`, –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏–º–æ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∏–º–æ –≤–ø–ª–∏–≤ –Ω–∞ —Ä–∞—Ö—É–Ω–æ–∫:

```bash
NoNewPrivileges=true
ProtectClock=true
SystemCallArchitectures=native
RestrictNamespaces=true
RestrictSUIDSGID=true
LockPersonality=true
RestrictRealtime=true
RestrictAddressFamilies=AF_INET AF_INET6 AF_UNIX
MemoryDenyWriteExecute=true
ProtectHostname=true
```

```bash
[user@rocky-vm ~]$ sudo systemctl daemon-reload
[user@rocky-vm ~]$ sudo systemctl restart httpd
[user@rocky-vm ~]$ systemd-analyze security --no-pager httpd | grep Overall
‚Üí Overall exposure level for httpd.service: 3.0 OK üôÇ
```

## –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è —Å–∏—Å—Ç–µ–º–Ω–∏—Ö –≤–∏–∫–ª–∏–∫—ñ–≤

–û–±–º–µ–∂–∏—Ç–∏ —Å–∏—Å—Ç–µ–º–Ω—ñ –≤–∏–∫–ª–∏–∫–∏ –º–æ–∂–µ –±—É—Ç–∏ –Ω–µ–ª–µ–≥–∫–æ. –í–∞–∂–∫–æ –≤–∏–∑–Ω–∞—á–∏—Ç–∏, —è–∫—ñ —Å–∏—Å—Ç–µ–º–Ω—ñ –≤–∏–∫–ª–∏–∫–∏ –º–∞—é—Ç—å –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –¥–µ—è–∫—ñ –¥–µ–º–æ–Ω–∏, —â–æ–± —Ñ—É–Ω–∫—Ü—ñ–æ–Ω—É–≤–∞—Ç–∏ –Ω–∞–ª–µ–∂–Ω–∏–º —á–∏–Ω–æ–º.

–£—Ç–∏–ª—ñ—Ç–∞ `strace` –º–æ–∂–µ –±—É—Ç–∏ –∫–æ—Ä–∏—Å–Ω–æ—é –¥–ª—è –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è —Ç–æ–≥–æ, —è–∫—ñ —Å–∏—Å—Ç–µ–º–Ω—ñ –≤–∏–∫–ª–∏–∫–∏ —Å—Ç–≤–æ—Ä—é—é—Ç—å—Å—è. –ü–∞—Ä–∞–º–µ—Ç—Ä `-f` –≤–∫–∞–∑—É—î –Ω–∞ —Ç–µ, —â–æ–± —Å—Ç–µ–∂–∏—Ç–∏ –∑–∞ —Ä–æ–∑–¥–≤–æ—î–Ω–∏–º–∏ –ø—Ä–æ—Ü–µ—Å–∞–º–∏, –∞ `-o` –∑–±–µ—Ä—ñ–≥–∞—î –≤–∏—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ —É —Ñ–∞–π–ª –ø—ñ–¥ –Ω–∞–∑–≤–æ—é `httpd.strace`.

```bash
[user@rocky-vm ~]$ sudo strace -f -o httpd.strace /usr/sbin/httpd
```

–ü—ñ—Å–ª—è –∑–∞–ø—É—Å–∫—É –ø—Ä–æ—Ü–µ—Å—É –Ω–∞ –¥–µ—è–∫–∏–π —á–∞—Å —ñ –≤–∑–∞—î–º–æ–¥—ñ—ó –∑ –Ω–∏–º –∑—É–ø–∏–Ω—ñ—Ç—å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è, —â–æ–± –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≤–∏—Ö—ñ–¥:

```bash
[user@rocky-vm ~]$ awk '{print $2}' httpd.strace | cut -d '(' -f 1 | sort | uniq | sed '/^[^a-zA-Z0-9]*$/d' | wc -l
79
```

–ü—ñ–¥ —á–∞—Å —Ä–æ–±–æ—Ç–∏ –ø—Ä–æ–≥—Ä–∞–º–∞ –∑–¥—ñ–π—Å–Ω–∏–ª–∞ 79 —É–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö —Å–∏—Å—Ç–µ–º–Ω–∏—Ö –≤–∏–∫–ª–∏–∫—ñ–≤.
–í–∏ –º–æ–∂–µ—Ç–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ —Å–ø–∏—Å–æ–∫ —Å–∏—Å—Ç–µ–º–Ω–∏—Ö –≤–∏–∫–ª–∏–∫—ñ–≤ —è–∫ –¥–æ–∑–≤–æ–ª–µ–Ω–∏–π –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –æ–¥–Ω–æ—Ä—è–¥–∫–∞:

```bash
[user@rocky-vm ~]$ echo SystemCallFilter=$(awk '{print $2}' httpd.strace | cut -d '(' -f 1 | sort | uniq | sed '/^[^a-zA-Z0-9]*$/d' | tr "\n" " ") | sudo tee -a /lib/systemd/system/httpd.service.d/override.conf
...
...
...
[user@rocky-vm ~]$ sudo systemctl daemon-reload
[user@rocky-vm ~]$ sudo systemctl restart httpd
[user@rocky-vm ~]$ systemd-analyze security --no-pager httpd | grep Overall
‚Üí Overall exposure level for httpd.service: 1.5 OK üôÇ
[user@rocky-vm ~]$ curl --head localhost
HTTP/1.1 403 Forbidden
```

–í–µ–±-—Å–µ—Ä–≤–µ—Ä –≤—Å–µ —â–µ –ø—Ä–∞—Ü—é—î, —ñ —Ä–∏–∑–∏–∫ –∑–Ω–∞—á–Ω–æ –∑–º–µ–Ω—à–∏–≤—Å—è.

–ù–∞–≤–µ–¥–µ–Ω–∏–π –≤–∏—â–µ –ø—ñ–¥—Ö—ñ–¥ —î —Ç–æ—á–Ω–∏–º. –Ø–∫—â–æ —Å–∏—Å—Ç–µ–º–Ω–∏–π –≤–∏–∫–ª–∏–∫ –ø—Ä–æ–ø—É—â–µ–Ω–æ, —Ü–µ –º–æ–∂–µ –ø—Ä–∏–∑–≤–µ—Å—Ç–∏ –¥–æ –∑–±–æ—é –ø—Ä–æ–≥—Ä–∞–º–∏. `systemd` –≥—Ä—É–ø—É—î —Å–∏—Å—Ç–µ–º–Ω—ñ –≤–∏–∫–ª–∏–∫–∏ –≤ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ –≤–∏–∑–Ω–∞—á–µ–Ω—ñ –Ω–∞–±–æ—Ä–∏. –©–æ–± —Å–ø—Ä–æ—Å—Ç–∏—Ç–∏ –æ–±–º–µ–∂–µ–Ω–Ω—è —Å–∏—Å—Ç–µ–º–Ω–∏—Ö –≤–∏–∫–ª–∏–∫—ñ–≤, –∑–∞–º—ñ—Å—Ç—å —Ç–æ–≥–æ, —â–æ–± –≤—Å—Ç–∞–Ω–æ–≤–ª—é–≤–∞—Ç–∏ –æ–¥–∏–Ω —Å–∏—Å—Ç–µ–º–Ω–∏–π –≤–∏–∫–ª–∏–∫ —É —Å–ø–∏—Å–æ–∫ –¥–æ–∑–≤–æ–ª–µ–Ω–∏—Ö –∞–±–æ –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–∏—Ö, –º–æ–∂–Ω–∞ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ —Ü—ñ–ª—É –≥—Ä—É–ø—É –≤ —Å–ø–∏—Å–∫—É –¥–æ–∑–≤–æ–ª–µ–Ω–∏—Ö –∞–±–æ –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–∏—Ö. –©–æ–± –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ —Å–ø–∏—Å–∫–∏:

```bash
[user@rocky-vm ~]$ systemd-analyze syscall-filter
@default
    # System calls that are always permitted
    arch_prctl
    brk
    cacheflush
    clock_getres
...
...
...
```

–°–∏—Å—Ç–µ–º–Ω—ñ –≤–∏–∫–ª–∏–∫–∏ –≤ –≥—Ä—É–ø–∞—Ö –º–æ–∂—É—Ç—å –∑–±—ñ–≥–∞—Ç–∏—Å—è, –æ—Å–æ–±–ª–∏–≤–æ –¥–ª—è –¥–µ—è–∫–∏—Ö –≥—Ä—É–ø, —è–∫—ñ –≤–∫–ª—é—á–∞—é—Ç—å —ñ–Ω—à—ñ –≥—Ä—É–ø–∏. –¢–∞–∫–∏–º —á–∏–Ω–æ–º, –æ–∫—Ä–µ–º—ñ –≤–∏–∫–ª–∏–∫–∏ –∞–±–æ –≥—Ä—É–ø–∏ –º–æ–∂–Ω–∞ –∑–∞–±–æ—Ä–æ–Ω–∏—Ç–∏, –≤–∫–∞–∑–∞–≤—à–∏ —Å–∏–º–≤–æ–ª `~`. –ù–∞—Å—Ç—É–ø–Ω—ñ –¥–∏—Ä–µ–∫—Ç–∏–≤–∏ —É —Ñ–∞–π–ª—ñ `override.conf` –ø–æ–≤–∏–Ω–Ω—ñ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –¥–ª—è —Ü—å–æ–≥–æ –ø—Ä–∏—Å—Ç—Ä–æ—é:

```bash
SystemCallFilter=@system-service
SystemCallFilter=~@privileged @resources @mount @swap @reboot
```

## –í–∏—Å–Ω–æ–≤–∫–∏

–ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –±–µ–∑–ø–µ–∫–∏ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –±—ñ–ª—å—à–æ—Å—Ç—ñ –±–ª–æ–∫—ñ–≤ `systemd` —î –Ω–µ–Ω–∞–ª–µ–∂–Ω–æ—é. –á—Ö –∑–º—ñ—Ü–Ω–µ–Ω–Ω—è –º–æ–∂–µ –∑–∞–π–Ω—è—Ç–∏ –¥–µ—è–∫–∏–π —á–∞—Å, –∞–ª–µ –≤–æ–Ω–æ —Ç–æ–≥–æ –≤–∞—Ä—Ç–µ, –æ—Å–æ–±–ª–∏–≤–æ —É –≤–µ–ª–∏–∫–∏—Ö —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞—Ö, –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –¥–æ –Ü–Ω—Ç–µ—Ä–Ω–µ—Ç—É. –Ø–∫—â–æ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –≤—Ä–∞–∑–ª–∏–≤—ñ—Å—Ç—å –∞–±–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—É –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é, –∑–∞—Ö–∏—â–µ–Ω–∏–π –±–ª–æ–∫ –º–æ–∂–µ –ø–µ—Ä–µ—à–∫–æ–¥–∏—Ç–∏ –π–æ–º—É –æ—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —Å–∏—Å—Ç–µ–º–æ—é.
