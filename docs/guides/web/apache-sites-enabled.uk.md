---
title: Кілька сайтів Apache
author: Steven Spencer
contributors: Ezequiel Bruni, Ganna Zhyrnova
tested_with: 8.5, 8.6, 9.0
tags:
  - web
  - apache
  - кілька сайтів
---

# Налаштування кількох сайтів веб-сервера Apache

## Що тобі потрібно

- Сервер під керуванням Rocky Linux

- Знання командного рядка та текстових редакторів. У цьому прикладі використовується _vi_, але ви можете скористатися своїм улюбленим редактором.

  !!! tip

            Якщо ви хочете дізнатися про текстовий редактор vi, [ось зручний підручник](https://www.tutorialspoint.com/unix/unix-vi-editor.htm).

- Базові знання встановлення та запуску веб-служб

## Вступ

У Rocky Linux є багато способів створити веб-сайт. Це лише один метод із використанням Apache на одному сервері. Розробка цього методу призначена для кількох серверів на одному апаратному забезпеченні, але він також може діяти як базова конфігурація для одного сервера сайту.

Історичний факт: це налаштування сервера, здається, було розпочато з систем на базі Debian, але його можна ідеально адаптувати до будь-якої операційної системи Linux, на якій працює Apache.

Для тих, хто шукає подібне налаштування для Nginx, [перегляньте цей посібник](nginx-multisite.md).

## Встановіть Apache

Ймовірно, вам знадобляться інші пакети для вашого веб-сайту, такі як PHP, бази даних або інші пакети. Встановлення PHP разом із `http` отримає найновішу версію з репозиторіїв Rocky Linux.

Просто пам’ятайте, що вам можуть знадобитися модулі, такі як `php-bcmath` або `php-mysqlind`. Специфікації вашої веб-програми визначатимуть, що вам потрібно. Ви можете встановити їх за потреби. Наразі ви встановите `http` та PHP, оскільки це майже вирішальний момент:

З командного рядка запустіть:

```bash
dnf install httpd php
```

## Додайте додаткові каталоги

Цей метод використовує пару додаткових каталогів, які наразі не існують у системі. Вам потрібно додати два каталоги в _/etc/httpd/_ з назвами "sites-available" та "sites-enabled".

З командного рядка введіть:

```bash
mkdir -p /etc/httpd/sites-available /etc/httpd/sites-enabled
```

Це створить обидва необхідні каталоги.

Вам також потрібен каталог, де будуть розміщені наші сайти. Це може бути де завгодно, але гарним способом упорядкувати все є створити каталог «піддоменів». Вставте це в /var/www: `mkdir /var/www/sub-domains/`, щоб зменшити складність.

## Конфігурація

Також потрібно додати рядок у нижню частину файлу `httpd.conf`. Для цього введіть:

```bash
vi /etc/httpd/conf/httpd.conf
```

і перейдіть у нижню частину файлу та додайте:

```bash
Include /etc/httpd/sites-enabled
```

Наші фактичні конфігураційні файли будуть у _/etc/httpd/sites-available_, і ви створите символічне посилання на них у _/etc/httpd /sites-enabled_.

**Навіщо ти це робиш?**

Скажімо, у вас є 10 веб-сайтів, які працюють на одному сервері з різними IP-адресами. Скажімо, на сайті B є кілька основних оновлень, і вам потрібно внести зміни в конфігурацію цього сайту. Також скажіть, що щось пішло не так зі внесеними змінами, і коли ви перезапускаєте `httpd` для зчитування змін, `httpd` не запускається. Не запуститься не тільки сайт, над яким ви працювали, але й інші. За допомогою цього методу ви можете видалити символічне посилання на сайт, який спричинив проблему, та перезапустити `httpd`. Він знову почне працювати, і ви зможете виправити несправну конфігурацію сайту.

Це знімає напругу, знаючи, що телефон не дзвонить із засмученим клієнтом або босом, оскільки послуга офлайн.

### Конфігурація сайту

Іншою перевагою цього методу є те, що він дозволяє нам повністю вказати все поза файлом `httpd.conf` за замовчуванням. Файл `httpd.conf` за замовчуванням завантажує значення за замовчуванням, а конфігурації вашого сайту виконують все інше. Чудово, правда? Крім того, знову ж таки, це робить усунення несправностей несправної конфігурації сайту менш складним.

Скажімо, у вас є веб-сайт, який завантажує вікі. Вам знадобиться файл конфігурації, який робить сайт доступним на порту 80.

Якщо ви хочете обслуговувати веб-сайт за допомогою SSL/TLS (і погодьтеся, у більшості випадків ви це робите), додайте ще один (майже ідентичний) розділ до цього файлу, щоб увімкнути порт 443.

Ви можете перевірити це нижче в розділі «Конфігурація `https` за допомогою сертифіката SSL/TLS».

Спочатку вам потрібно створити цей файл конфігурації в _sites-available_:

```bash
vi /etc/httpd/sites-available/com.wiki.www
```

Вміст файлу конфігурації виглядатиме приблизно так:

```apache
<VirtualHost *:80>
        ServerName your-server-hostname
        ServerAdmin username@rockylinux.org
        DocumentRoot /var/www/sub-domains/your-server-hostname/html
        DirectoryIndex index.php index.htm index.html
        Alias /icons/ /var/www/icons/
        # ScriptAlias /cgi-bin/ /var/www/sub-domains/your-server-hostname/cgi-bin/

    CustomLog "/var/log/httpd/your-server-hostname-access_log" combined
    ErrorLog  "/var/log/httpd/your-server-hostname-error_log"

        <Directory /var/www/sub-domains/your-server-hostname/html>
                Options -ExecCGI -Indexes
                AllowOverride None

                Order deny,allow
                Deny from all
                Allow from all

                Satisfy all
        </Directory>
</VirtualHost>
```

Після створення вам потрібно записати (зберегти) його за допомогою ++shift+colon+w+q++.

У цьому прикладі завантаження вікі-сайту відбувається з підкаталогу «html» _your-server-hostname_, що означає, що шлях, який ви створили в _/var/www_ (вище) знадобиться кілька додаткових каталогів, щоб задовольнити це:

```bash
mkdir -p /var/www/sub-domains/your-server-hostname/html
```

Це створить весь шлях за допомогою однієї команди. Далі ви хочете встановити свої файли в цей каталог, у якому буде працювати веб-сайт. Це може бути те, що ви зробили самі, або веб-програма, яку можна встановити (у цьому випадку вікі), яку ви завантажили.

Скопіюйте ваші файли на створений шлях:

```bash
cp -Rf wiki_source/* /var/www/sub-domains/your-server-hostname/html/
```

## Конфігурація `https` за допомогою сертифіката SSL/TLS

Як зазначалося раніше, кожен створений сьогодні веб-сервер _має_ працювати з SSL/TLS (рівень захищених сокетів).

Цей процес починається зі створення закритого ключа та CSR (запиту на підписання сертифіката) і надсилання CSR до центру сертифікації для придбання сертифіката SSL/TLS. Процес генерації цих ключів є дещо розширеним.

Якщо ви не знайомі з генерацією ключів SSL/TLS, перегляньте: [Генерація ключів SSL](../security/ssl_keys_https.md)

Ви також можете скористатися цим альтернативним процесом, використовуючи [сертифікат SSL від Let's Encrypt](../security/generating_ssl_keys_lets_encrypt.md)

### Розміщення ключів і сертифікатів SSL/TLS

Оскільки у вас є ваші ключі та файли сертифікатів, ви повинні розмістити їх логічно у своїй файловій системі на веб-сервері. Як ви бачили з прикладу конфігураційного файлу, ви розміщуєте свої веб-файли в `/var/www/sub-domains/your-server-hostname/html`.

Ви бажаєте розмістити свій сертифікат і ключові файли в домені, але за межами кореня документа, яким у даному випадку є папка _html_.

Ви ніколи не захочете розкрити свої сертифікати та ключі в Інтернеті. Це було б погано!

Натомість ви створите структуру каталогів для наших файлів SSL/TLS поза коренем документа:

```bash
mkdir -p /var/www/sub-domains/your-server-hostname/ssl/{ssl.key,ssl.crt,ssl.csr}`
```

Якщо ви новачок у синтаксисі «дерева» для створення каталогів, то вище сказано:

«Створіть каталог під назвою «ssl» і три каталоги всередині під назвою ssl.key, ssl.crt і ssl.csr»

Попереднє зауваження: зберігати файл із запитом на підписання сертифіката (CSR) у дереві непотрібно, але це спрощує деякі речі. Якщо вам колись знадобиться повторно видати сертифікат від іншого постачальника, гарною ідеєю буде мати збережену копію файлу CSR. Виникає питання, де ви можете зберегти це, щоб запам’ятати, і логічно зберігати його в дереві вашого веб-сайту.

Якщо припустити, що ви назвали файли ключа, csr і crt (сертифікат) іменем свого сайту та зберегли їх у _/root_, ви скопіюєте їх до місця розташування:

```bash
cp /root/com.wiki.www.key /var/www/sub-domains/your-server-hostname/ssl/ssl.key/
cp /root/com.wiki.www.csr /var/www/sub-domains/your-server-hostname/ssl/ssl.csr/
cp /root/com.wiki.www.crt /var/www/sub-domains/your-server-hostname/ssl/ssl.crt/
```

### Конфігурація сайту - `https`

Після того, як ви згенерували свої ключі та придбали сертифікат SSL/TLS, ви можете перейти до налаштування веб-сайту за допомогою своїх ключів.

Для початку розбийте початок конфігураційного файлу. Наприклад, навіть якщо ви все ще хочете прослуховувати вхідні запити на порту 80 (стандартний порт `http`), ви не хочете, щоб жоден з цих запитів фактично надсилався на порт 80.

Ви хочете, щоб вони переходили на порт 443 (або "`http` secure", більш відомий як SSL/TLS або `https`). Наш розділ конфігурації порту 80 буде мінімальним:

```apache
<VirtualHost *:80>
        ServerName your-server-hostname
        ServerAdmin username@rockylinux.org
        Redirect / https://your-server-hostname/
</VirtualHost>
```

Це означає, що будь-який звичайний веб-запит слід надсилати до конфігурації `https`. Відображена опція "Перенаправлення" apache є тимчасовою. Коли тестування буде завершено, і ви побачите, що сайт працює належним чином, ви можете змінити це на «Переадресувати постійно».

Постійне переспрямування навчить пошукові системи, і незабаром будь-який трафік на ваш сайт, який надходить із пошукових систем, спрямовуватиметься лише на порт 443 (`https`) без потрапляння на порт 80 (`http`) спочатку.

Далі вам потрібно визначити частину `https` файлу конфігурації:

!!! info

    Починаючи з Apache 2.4.8, директива `SSLCertificateChainFile` застаріла. Розширення директиви `SSLCertificateFile` включає сертифікат CA постачальника.

```apache
<VirtualHost *:80>
        ServerName your-server-hostname
        ServerAdmin username@rockylinux.org
        Redirect / https://your-server-hostname/
</VirtualHost>
<Virtual Host *:443>
        ServerName your-server-hostname
        ServerAdmin username@rockylinux.org
        DocumentRoot /var/www/sub-domains/your-server-hostname/html
        DirectoryIndex index.php index.htm index.html
        Alias /icons/ /var/www/icons/
        # ScriptAlias /cgi-bin/ /var/www/sub-domains/your-server-hostname/cgi-bin/

    CustomLog "/var/log/`http`d/your-server-hostname-access_log" combined
    ErrorLog  "/var/log/`http`d/your-server-hostname-error_log"

        SSLEngine on
        SSLProtocol all -SSLv2 -SSLv3 -TLSv1
        SSLHonorCipherOrder on
        SSLCipherSuite EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384
:EECDH+aRSA+SHA256:EECDH+aRSA+RC4:EECDH:EDH+aRSA:RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS

        SSLCertificateFile /var/www/sub-domains/your-server-hostname/ssl/ssl.crt/com.wiki.www.crt
        SSLCertificateKeyFile /var/www/sub-domains/your-server-hostname/ssl/ssl.key/com.wiki.www.key

        <Directory /var/www/sub-domains/your-server-hostname/html>
                Options -ExecCGI -Indexes
                AllowOverride None

                Order deny,allow
                Deny from all
                Allow from all

                Satisfy all
        </Directory>
</VirtualHost>
```

Отже, розбиваючи цю конфігурацію далі, після звичайних частин конфігурації та вниз до розділу SSL/TLS:

- SSLEngine on - каже використовувати SSL/TLS
- SSLProtocol all -SSLv2 -SSLv3 -TLSv1 - каже використовувати всі доступні протоколи, окрім тих, що містять уразливості. Ви повинні періодично досліджувати протоколи, прийнятні для використання.
- SSLHonorCipherOrder on -це стосується наступного рядка, що стосується наборів шифрів, і каже мати справу з ними у вказаному порядку. Це ще одна область, де періодично слід переглядати набори шифрів.
- SSLCertificateFile - це саме те, що в ньому сказано: нещодавно придбаний і застосований файл сертифіката та його розташування
- SSLCertificateKeyFile - ключ, який ви створили під час створення запиту на підписання сертифіката

Візьміть усе в режимі реального часу, і якщо веб-служба не запускає жодних помилок і якщо перехід на ваш веб-сайт показує `https` без помилок, ви готові до роботи.

## Оживіть його

Пам’ятайте, що наш файл _httpd.conf_ містить _/etc/httpd/sites-enabled_ в кінці файлу. Коли `httpd` перезавантажиться, він завантажить усі файли конфігурації, що знаходяться в каталозі _sites-enabled_. Річ у тім, що всі наші файли конфігурації знаходяться в _sites-available_.

Це задумано так, щоб ви могли видаляти елементи, коли або якщо `httpd` не вдається перезапустити. Щоб увімкнути наш файл конфігурації, вам потрібно створити символічне посилання на цей файл у _sites-enabled_ та запустити або перезапустити веб-сервіс. Для цього ви використовуєте цю команду:

```bash
ln -s /etc/httpd/sites-available/your-server-hostname /etc/httpd/sites-enabled/
```

Це створить посилання на файл конфігурації в _sites-enabled_, як ми хочемо.

Тепер просто запустіть `httpd` за допомогою `systemctl start httpd`. Або перезапустіть його, якщо він вже запущено: `systemctl restart httpd`, і, припускаючи, що веб-сервіс перезавантажиться, тепер ви можете виконати деякі тести на своєму сайті.
