---
title: Локальна документація - LXD
author: Steven Spencer
contributors: Ezequiel Bruni
tested_with: 8.5, 8.6
tags:
  - сприяти
  - локальне середовище lxd
---

# Вступ

Є кілька способів запустити копію `mkdocs`, щоб точно побачити, як виглядатиме ваш документ Rocky Linux після об’єднання в живу систему. Цей документ стосується використання контейнера LXD на вашій локальній робочій станції для відокремлення коду Python у `mkdocs` від інших проектів, над якими ви можете працювати.

Рекомендується зберігати проекти окремо, щоб уникнути проблем із кодом робочої станції.

Це також партнерський документ для [версії Docker тут](rockydocs_web_dev.md).

## Передумови та припущення

Кілька речей, які ви повинні мати/знати/бути:

* Знайомство та комфорт роботи з командним рядком
* Комфортно користуватися інструментами для редагування, SSH і синхронізації або готовий слідкувати за цим і вчитися
* Ми посилатимемося на LXD – тут є довгий документ про [створення та використання LXD на сервері](../../books/lxd_server/00-toc.md), але ми будемо використовувати лише базову інсталяцію на нашій робочій станції Linux. Цей документ припускає, що ви вже використовуєте LXD для інших речей, і не охоплює створення та ініціалізацію LXD.
* Ми будемо використовувати `lsyncd` для віддзеркалення файлів, і ви можете знайти [документацію про це тут](../backup/mirroring_lsyncd.md)
* Вам знадобляться відкриті ключі, згенеровані для вашого користувача та користувача «root» на локальній робочій станції за допомогою [цього документа](../security/ssh_public_private_keys.md)
* Наш інтерфейс мосту працює на 10.56.233.1, а наш контейнер працює на 10.56.233.189 у наших прикладах нижче.
* "youruser" у цьому документі представляє ваш ідентифікатор користувача, тому замініть його власним.
* Ми припускаємо, що ви вже розробляєте документацію за допомогою клону сховища документації на вашій робочій станції.

## Контейнер mkdocs

### Створіть контейнер

Наш перший крок — створити контейнер LXD. Тут не потрібно використовувати нічого, окрім значень за замовчуванням, тому дозвольте створити свій контейнер за допомогою інтерфейсу мосту.

Ми додамо контейнер Rocky до нашої робочої станції для `mkdocs`, тому ми просто назвемо його «mkdocs»:

```
lxc launch images:rockylinux/8 mkdocs
```

Контейнер потрібно налаштувати за допомогою проксі. За замовчуванням, коли `mkdocs serve` запускається, він працює на 127.0.0.1:8000. Це добре, коли він знаходиться на вашій локальній робочій станції без контейнера. Однак, якщо він знаходиться в **контейнері** LXD на вашій локальній робочій станції, вам потрібно налаштувати контейнер із проксі-портом. Це робиться за допомогою:

```
lxc config device add mkdocs mkdocsport proxy listen=tcp:0.0.0.0:8000 connect=tcp:127.0.0.1:8000
```

У рядку вище «mkdocs» — це ім’я нашого контейнера, «mkdocsport» — довільне ім’я, яке ми надаємо проксі-порту, тип — «proxy», а потім ми прослуховуємо всі інтерфейси tcp на порту 8000 і підключаємось до локального хосту для цього контейнера на порту 8000.

!!! Note "Примітка"

    Якщо ви запускаєте екземпляр lxd на іншій машині у вашій мережі, не забудьте переконатися, що порт 8000 відкритий у брандмауері.

### Встановлення пакетів

Спочатку зайдіть в контейнер з:

```
lxc exec mkdocs bash
```

!!! warning "Зміни у requirements.txt для 8.x"

    Поточний `requirements.txt` потребуватиме новішої версії Python, ніж та, яка встановлена за замовчуванням у Rocky Linux 8.5 або 8.6. Щоб мати можливість інсталювати всі інші залежності, виконайте такі дії:

    ```
    sudo dnf module enable python38
    sudo dnf install python38
    ```


    Після цього ви можете пропустити встановлення `python3-pip` у пакетах, наведених нижче.

Нам знадобиться кілька пакетів, щоб виконати те, що нам потрібно:

```
dnf install git openssh-server python3-pip rsync
```

Після встановлення нам потрібно ввімкнути та запустити `sshd`:

```
systemctl enable --now sshd
```
### Користувачі контейнерів

Нам потрібно встановити пароль для нашого користувача root, а потім додати нашого користувача (користувача, якого ви використовуєте на локальній машині) до списку sudoers. На даний момент ми повинні бути користувачем «root», тому, щоб змінити тип пароля:

```
passwd
```

І встановіть пароль на щось надійне та таке, що запам’ятовується.

Далі додайте свого користувача та встановіть пароль:

```
adduser youruser
passwd youruser
```

І додайте свого користувача до групи sudoers:

```
usermod -aG wheel youruser
```

На цьому етапі ви зможете підключитися до контейнера через SSH, використовуючи або користувача root, або користувача з робочої станції та ввівши пароль. Перш ніж продовжити, переконайтеся, що ви можете це зробити.

## SSH для root і вашого користувача

У цій процедурі root-користувач (як мінімум) повинен мати можливість входити в контейнер через SSH без введення пароля; це через процес `lsyncd`, який ми будемо застосовувати. Тут ми припускаємо, що ви можете sudo для користувача root на вашій локальній робочій станції:

```
sudo -s
```

Ми також припускаємо, що користувач root має ключ `id_rsa.pub` у каталозі `./ssh`. Якщо ні, створіть його за допомогою [цієї процедури](../security/ssh_public_private_keys.md):

```
ls -al .ssh/
drwx------  2 root root 4096 Feb 25 08:06 .
drwx------ 14 root root 4096 Feb 25 08:10 ..
-rw-------  1 root root 2610 Feb 14  2021 id_rsa
-rw-r--r--  1 root root  572 Feb 14  2021 id_rsa.pub
-rw-r--r--  1 root root  222 Feb 25 08:06 known_hosts
```

Щоб отримати доступ SSH до нашого контейнера без необхідності вводити пароль, поки існує ключ `id_rsa.pub`, як це було описано вище, все, що нам потрібно зробити, це виконати:

```
ssh-copy-id root@10.56.233.189
```

Однак для нашого користувача нам потрібен увесь каталог .ssh/, скопійований у наш контейнер. Причина в тому, що ми збережемо все ідентичне для цього користувача, щоб наш доступ до GitHub через SSH був однаковим.

Щоб скопіювати все до нашого контейнера, нам просто потрібно зробити це як ваш користувач, **а не** sudo:

```
scp -r .ssh/ youruser@10.56.233.189:/home/youruser/
```

Далі введіть SSH у контейнер як ваш користувач:

```
ssh -l youruser 10.56.233.189
```

Нам потрібно зробити речі ідентичними, і це робиться за допомогою `ssh-add`. Для цього ми повинні переконатися, що у нас є доступний `ssh-agent`. Введіть наступне:

```
eval "$(ssh-agent)"
ssh-add
```

## Клонування сховищ

Нам потрібно клонувати два репозиторії, але не потрібно додавати віддалені `git`. У сховищі документації тут відображатиметься лише поточна документація (віддзеркалена з вашої робочої станції) та документи.

Репозиторій rockylinux.org використовуватиметься для запуску `mkdocs serve` та використовуватиме дзеркало як джерело. Усі ці кроки слід виконувати від імені користувача без права root. Якщо ви не можете клонувати репозиторії як свій ідентифікатор користувача, то **Є** проблема з вашою ідентичністю, що стосується `git`, і вам потрібно переглянути кілька останніх кроків для повторного створення вашого середовища ключів (вище).

Спочатку клонуйте документацію:

```
git clone git@github.com:rocky-linux/documentation.git
```

Якщо припустити, що це спрацювало, клонуйте docs.rockylinux.org:

```
git clone git@github.com:rocky-linux/docs.rockylinux.org.git
```

Якщо все вийшло, як планувалося, то можна рухатися далі.

## Налаштування mkdocs

Встановлення необхідних плагінів виконується за допомогою `pip3` і файлу «requirements.txt» у каталозі docs.rockylinux.org. Хоча цей процес буде суперечити вам щодо використання користувача root для запису змін до системних каталогів, ви повинні запустити його як root.

Ми робимо це за допомогою `sudo`.

Перейти в каталог:

```
cd docs.rockylinux.org
```

А потім запустіть:

```
sudo pip3 install -r requirements.txt
```

Далі ми повинні налаштувати `mkdocs` з додатковим каталогом. Зараз `mkdocs` вимагає створення каталогу документів, а потім посилання на каталог документації/документів під ним. Все це робиться за допомогою:

```
mkdir docs
cd docs
ln -s ../../documentation/docs
```
### Тестування mkdocs

Тепер, коли ми налаштували `mkdocs`, давайте спробуємо запустити сервер. Пам’ятайте, що цей процес буде стверджувати, що це схоже на виробництво. Це не так, тому ігноруйте попередження. Запустіть `mkdocs serve` за допомогою:

```
mkdocs serve -a 0.0.0.0:8000
```

Ви повинні побачити щось подібне на консолі:

```
INFO     -  Building documentation...
WARNING  -  Config value: 'dev_addr'. Warning: The use of the IP address '0.0.0.0' suggests a production environment or the use of a
            proxy to connect to the MkDocs server. However, the MkDocs' server is intended for local development purposes only. Please
            use a third party production-ready server instead.
INFO     -  Adding 'sv' to the 'plugins.search.lang' option
INFO     -  Adding 'it' to the 'plugins.search.lang' option
INFO     -  Adding 'es' to the 'plugins.search.lang' option
INFO     -  Adding 'ja' to the 'plugins.search.lang' option
INFO     -  Adding 'fr' to the 'plugins.search.lang' option
INFO     -  Adding 'pt' to the 'plugins.search.lang' option
WARNING  -  Language 'zh' is not supported by lunr.js, not setting it in the 'plugins.search.lang' option
INFO     -  Adding 'de' to the 'plugins.search.lang' option
INFO     -  Building en documentation
INFO     -  Building de documentation
INFO     -  Building fr documentation
INFO     -  Building es documentation
INFO     -  Building it documentation
INFO     -  Building ja documentation
INFO     -  Building zh documentation
INFO     -  Building sv documentation
INFO     -  Building pt documentation
INFO     -  [14:12:56] Reloading browsers
```

А тепер момент істини!  Якщо ви зробили все правильно вище, ви зможете відкрити веб-браузер і перейти до IP-адреси свого контейнера на порту :8000 і переглянути сайт документації.

У нашому прикладі ми введемо наступне в адресу веб-переглядача (**ПРИМІТКА** Щоб уникнути пошкоджених URL-адрес, IP-адресу тут було змінено на «your-server-ip». Потрібно просто підставити в IP):

```
http://your-server-ip:8000
```
## lsyncd

Ми майже готові, якщо ви бачили документацію у веб-переглядачі. Останнім кроком є синхронізація документації у вашому контейнері з документацією на локальній робочій станції.

Як зазначалося вище, ми робимо це тут за допомогою `lsyncd`.

`lsyncd` встановлюється по-різному залежно від версії Linux, яку ви використовуєте. [У цьому документі](../backup/mirroring_lsyncd.md) описано способи встановлення на Rocky Linux, а також із джерела. Якщо ви використовуєте якийсь інший тип Linux (наприклад, Ubuntu), вони зазвичай мають власні пакети, але в них є нюанси.

Ubuntu, наприклад, називає файл конфігурації по-різному. Просто майте на увазі, що якщо ви використовуєте інший тип робочої станції Linux, окрім Rocky Linux, і не бажаєте встановлювати з вихідного коду, ймовірно, для вашої платформи є доступні пакунки.

Наразі ми припускаємо, що ви використовуєте робочу станцію Rocky Linux і використовуєте метод встановлення RPM із включеного документа.

### Конфігурація

!!! Note
    Користувач root повинен запускати демон, тому ви повинні бути root для створення файлів конфігурації та журналів. Для цього ми припускаємо `sudo -s`.

Для `lsyncd` нам потрібні деякі файли журналу для запису:

```
touch /var/log/lsyncd-status.log
touch /var/log/lsyncd.log
```

Нам також потрібно створити файл виключення, хоча в цьому випадку ми нічого не виключаємо:

```
touch /etc/lsyncd.exclude
```

Нарешті нам потрібно створити файл конфігурації. У цьому прикладі ми використовуємо `vi` як наш редактор, але ви можете використовувати будь-який редактор, який вам зручно:

```
vi /etc/lsyncd.conf
```

А потім помістіть цей вміст у цей файл і збережіть його. Обов’язково замініть «youruser» на фактичного користувача, а IP-адресу — на власну IP-адресу контейнера:

```
settings {
   logfile = "/var/log/lsyncd.log",
   statusFile = "/var/log/lsyncd-status.log",
   statusInterval = 20,
   maxProcesses = 1
   }

sync {
   default.rsyncssh,
   source="/home/youruser/documentation",
   host="root@10.56.233.189",
   excludeFrom="/etc/lsyncd.exclude",
   targetdir="/home/youruser/documentation",
   rsync = {
     archive = true,
     compress = false,
     whole_file = false
   },
   ssh = {
     port = 22
   }
}
```

Ми припускаємо, що ви ввімкнули `lsyncd` під час встановлення, тому на цьому етапі нам потрібно просто запустити або перезапустити процес:

```
systemctl restart lsyncd
```

Щоб переконатися, що все працює, перевірте журнали, зокрема `lsyncd.log`, який повинен показати вам щось на кшталт цього, якщо все запущено правильно:

```
Fri Feb 25 08:10:16 2022 Normal: --- Startup, daemonizing ---
Fri Feb 25 08:10:16 2022 Normal: recursive startup rsync: /home/youruser/documentation/ -> root@10.56.233.189:/home/youruser/documentation/
Fri Feb 25 08:10:41 2022 Normal: Startup of "/home/youruser/documentation/" finished: 0
Fri Feb 25 08:15:14 2022 Normal: Calling rsync with filter-list of new/modified files/dirs
```

## Висновок

Коли ви зараз працюєте над документацією вашої робочої станції, будь то `git pull` чи гілка, яку ви створюєте, щоб створити документ (як цей!), ви побачите, як зміни з’являться у вашій документації в контейнері, а `mkdocs serve` покаже вам вміст у вашому веб-переглядачі.

Рекомендується виконувати весь код Python окремо від будь-якого іншого коду Python, який ви, можливо, розробляєте. Контейнери LXD можуть зробити це набагато простіше; спробуйте цей метод і перевірте, чи працює він для вас.
