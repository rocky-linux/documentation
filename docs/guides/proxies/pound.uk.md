---
title: Pound
author: Steven Spencer
contributors:
tested_with: 8.5, 8.6
tags:
  - proxy
  - proxies
---

# Проксі-сервер Pound

!!! warning "Pound відсутній в EPEL-9"

    На момент написання цієї статті на Rocky Linux 9.0 Pound неможливо встановити зі сховища EPEL. Хоча існують джерела пакетів SRPM, ми не можемо перевірити цілісність цих джерел. З цієї причини ми не рекомендуємо зараз встановлювати проксі-сервер Pound на Rocky Linux 9.0. Це може змінитися, якщо EPEL знову підніме Pound.  Використовуйте цю процедуру спеціально для версій Rocky Linux 8.x.

## Вступ

Pound — це незалежний від веб-сервера зворотний проксі та балансувальник навантаження, який дуже простий у налаштуванні та керуванні. Він не використовує веб-службу, але прослуховує порти веб-служби (http, https).

Тепер існує багато параметрів проксі-сервера, деякі з яких згадуються на цих сторінках документації. Існує документ про використання [HAProxy тут](haproxy_apache_lxd.md), а в інших документах є посилання на використання Nginx для зворотного проксі.

Сервіси балансування навантаження дуже корисні для завантаженого середовища веб-сервера. Багато проксі-серверів, включаючи згаданий раніше HAProxy, можна використовувати для багатьох типів послуг.

У випадку Pound його можна використовувати лише для веб-сервісів, але він хороший у тому, що робить.

## Передумови та припущення

Нижче наведено мінімальні вимоги для використання цієї процедури:

* Бажання збалансувати навантаження між кількома веб-сайтами або готовність вивчити новий інструмент роблять те саме.
* Можливість виконувати команди від імені користувача root або використовувати `sudo`, щоб отримати доступ до них.
* Знайомство з редактором командного рядка. Тут ми використовуємо `vi` або `vim`, але не соромтеся замінити їх у свій улюблений редактор.
* Комфорт зі зміною портів прослуховування на кількох типах веб-серверів.
* Ми припускаємо, що сервери Nginx і Apache вже встановлені.
* Ми припускаємо, що ви використовуєте сервери або контейнери Rocky Linux для всього тут.
* Хоча ми робимо всілякі заяви щодо `https` нижче, цей посібник стосується лише служби `http`. Щоб правильно виконувати `https`, ви повинні налаштувати ваш pound-сервер за допомогою справжнього сертифіката від фактичного центру сертифікації.

!!! tip "Підказка"

    Якщо у вас не встановлено жоден із цих серверів, ви можете зробити це в контейнерному середовищі (LXD або Docker) або на голому металі та запустити їх у роботу. Для цієї процедури ви повинні встановити їх разом із відповідними пакетами, увімкнути та запустити служби. Ми не будемо жодним чином їх суттєво змінювати.

    ```
    dnf -y install nginx && systemctl enable --now nginx
    ```


    або

    ```
    dnf -y install httpd && systemctl enable --now httpd
    ```

## Умовності

Для цієї процедури ми будемо використовувати два веб-сервери (відомі як внутрішні сервери), на одному з яких працює Nginx (192.168.1.111), а на другому — Apache (192.168.1.108).

Наш сервер Pound (192.168.1.103) буде вважатися шлюзом.

І було б найкраще, якби ви ніколи не забували пам’ятати про безпеку під час налаштування будь-якої служби, включаючи проксі-сервер з балансуванням завантажень. Нижче все буде детально описано, тому хвилюватися з цього приводу зайве.

!!! note "Примітка"

    Не забудьте змінити пов’язані IP-адреси на будь-які, які вони є у вашому середовищі, і замінити їх там, де це можливо, протягом цієї процедури.

## Встановлення сервера Pound

Щоб інсталювати Pound, нам потрібно спочатку інсталювати EPEL (додаткові пакети для Enterprise Linux) і запустити оновлення на випадок, якщо в EPEL з’явиться щось нове:

```
dnf -y install epel-release && dnf -y update
```

Потім встановіть Pound. (Так, це велика "P"):

```
dnf -y install Pound
```

## Налаштування Pound

Тепер, коли пакунки встановлено, нам потрібно налаштувати Pound. Ми будемо використовувати `vi`, щоб оновити це, але якщо ви віддаєте перевагу `nano` або щось інше, замініть це в:

```bash
vi /etc/pound.cfg
```

Файл налаштовано з інформацією за замовчуванням, що дозволяє легко побачити більшість стандартних компонентів Pound:

```bash
User "pound"
Group "pound"
Control "/var/lib/pound/pound.cfg"

ListenHTTP
    Address 0.0.0.0
    Port 80
End

ListenHTTPS
    Address 0.0.0.0
    Port    443
    Cert    "/etc/pki/tls/certs/pound.pem"
End

Service
    BackEnd
        Address 127.0.0.1
        Port    8000
    End

    BackEnd
        Address 127.0.0.1
        Port    8001
    End
End
```

### Придивляючись ближче

* Про "User" та "Group" подбали під час встановлення
* Файл "Control" ніде не використовується.
* Розділ «ListenHTTP» представляє службу `http` (порт 80) і «Address», який проксі-сервер слухатиме. Ми змінимо це на фактичну IP-адресу нашого сервера Pound.
* Розділ «ListenHTTPS» представляє службу `https` (порт 443) і «Address», який проксі-сервер слухатиме. Як і вище, ми змінимо це на IP-адресу сервера Pound. Опція «Cert» — це самопідписаний сертифікат, наданий процесом встановлення Pound. Ви б хотіли замінити це у робочому середовищі справжнім сертифікатом за допомогою однієї з цих процедур: [Генерація ключів SSL](../security/ssl_keys_https.md) або [Ключі SSL із Let's Encrypt](. ./security/generating_ssl_keys_lets_encrypt.md).
* Розділ «Сервіс» налаштовує «BackEnd» сервери з їх портами прослуховування. Ви можете мати скільки завгодно "BackEnd" серверів.

### Зміна конфігурації

* змініть IP-адресу в обох параметрах прослуховування на IP-адресу нашого сервера Pound, 192.168.1.103
* змініть IP-адреси та порти в розділах «BackEnd» відповідно до нашої конфігурації, знайденої в «Умовних поняттях» вище (IP-адреси та порти)

Коли ви закінчите змінювати конфігурацію, ви повинні мати змінений файл, який виглядає приблизно так:

```bash
User "pound"
Group "pound"
Control "/var/lib/pound/pound.cfg"

ListenHTTP
    Address 192.168.1.103
    Port 80
End

ListenHTTPS
    Address 192.168.1.103
    Port    443
    Cert    "/etc/pki/tls/certs/pound.pem"
End

Service
    BackEnd
        Address 192.168.1.111
        Port    8080
    End

    BackEnd
        Address 192.168.1.108
        Port    8081
    End
End
```

## Налаштування Nginx для прослуховування на 8080

Оскільки ми встановили порт прослуховування для Nginx у нашій конфігурації Pound на 8080, нам також потрібно зробити цю зміну на нашому запущеному сервері Nginx. Ми робимо це, змінюючи `nginx.conf`:

```bash
vi /etc/nginx/nginx.conf
```

Ви просто хочете змінити рядок «listen» на новий номер порту:

```bash
listen       8080 default_server;
```

Збережіть зміни та перезапустіть службу nginx:

```
systemctl restart nginx
```

## Налаштування Apache для прослуховування 8081

Оскільки ми встановили порт прослуховування для Apache у нашій конфігурації Pound на 8081, нам також потрібно зробити цю зміну на нашому запущеному сервері Apache. Ми робимо це, змінюючи `httpd.conf`:

```bash
vi /etc/httpd/conf/httpd.conf
```

Ви хочете змінити рядок «Listen» на новий номер порту:

```bash
Listen 8081
```

Збережіть зміни та перезапустіть службу httpd:

```
systemctl restart httpd
```

## Перевірка та запуск

Після того, як ваші веб-служби запущені та прослуховують правильні порти на кожному з наших серверів, наступним кроком буде ввімкнення служби pound на сервері Pound:

```
systemctl enable --now pound
```

!!! warning "Важливо"

    Використання Nginx і Apache, як ми робимо тут для демонстрації, означатиме, що сервер Nginx майже завжди відповідатиме першим. З цієї причини для ефективного тестування вам потрібно буде призначити низький пріоритет серверу Nginx, щоб ви могли бачити обидва екрани. Це багато говорить про швидкість Nginx над Apache. Щоб змінити пріоритет для сервера Nginx, вам просто потрібно додати пріоритет (1-9, де 9 є найнижчим пріоритетом) у розділі «BackEnd» для сервера Nginx таким чином:

    ```
    BackEnd
        Address 192.168.1.111
        Port    8080
        Priority 9
    End
    ```

Коли ви відкриваєте Ip проксі-сервера у веб-браузері, ви повинні зіткнутися з одним із цих двох екранів:

![Pound Nginx](images/pound_nginx.jpg)

Або

![Pound Apache](images/pound_apache.jpg)

## Використання екстреної допомоги

Єдине, що вам може знадобитися під час використання балансувальника навантаження, такого як Pound, це відключити виробничі сервери для обслуговування або мати запасний «BackEnd» для повного збою. Це робиться за допомогою оголошення "Emergency" у файлі `pound.conf`. На одну послугу можна мати лише одну «Надзвичайну» декларацію. У нашому випадку це з’явиться в кінці розділу «Сервіс» у файлі конфігурації:

```
...
Service
    BackEnd
        Address 192.168.1.117
        Port    8080
    Priority 9
    End

    BackEnd
        Address 192.168.1.108
        Port    8081
    End
    Emergency
       Address 192.168.1.104
       Port 8000
   End
End
```

Цей сервер може відображати лише повідомлення "Down For Maintenance".

## Міркування безпеки

Більшість документів, що стосуються проксі-серверів балансування навантаження, не розглядають питання безпеки. Наприклад, якщо це загальнодоступний веб-сервер, вам потрібно буде мати служби `http` і `https`, відкриті для світу на проксі-сервері балансування навантаження. Але як щодо «BackEnd» серверів?

До них можна отримати доступ лише через їхні порти з самого сервера Pound. Тим не менш, оскільки сервер Pound переспрямовує на 8080 або 8081 на серверах BackEnd, і оскільки сервери BackEnd мають `http` прослуховування цих наступних портів, ви можете використовувати назви служб для команд брандмауера на цих серверах BackEnd серверів.

У цьому розділі буде розглянуто ці проблеми та команди `firewalld`, необхідні для блокування всього.

!!! warning "Важливо"

    Ми припускаємо, що ви маєте прямий доступ до відповідних серверів і не віддалені від них. Якщо ви віддалені, будьте вкрай обережні, видаляючи служби із зони `firewalld`!
    
    Ви можете випадково заблокувати себе на своєму сервері.

### Брандмауер - сервер Pound

Для сервера Pound, як зазначено вище, ми хочемо дозволити `http` і `https` зі світу. Було б найкраще розглянути, чи потрібно дозволити `ssh` зі світу. Якщо ви локально на сервері, це, мабуть, **НІ**. Ми припускаємо, що сервер тут доступний через вашу локальну мережу і ви маєте прямий доступ до нього, тому ми будемо заблокувати `ssh` для IP-адрес нашої локальної мережі.

Щоб виконати вищезазначене, ми будемо використовувати вбудований брандмауер для Rocky Linux, `firewalld` і структуру команд `firewall-cmd`. Ми також будемо використовувати дві вбудовані зони, «"public» та «trusted», для простоти.

Почнемо з додавання наших вихідних IP-адрес до «trusted» зони. Ось наша локальна мережа (у нашому прикладі: 192.168.1.0/24):

```
firewall-cmd --zone=trusted --add-source=192.168.1.0/24 --permanent
```

Тоді давайте додамо службу `ssh` до зони:

```
firewall-cmd --zone=trusted --add-service=ssh --permanent
```

Коли все це буде завершено, перезавантажте брандмауер за допомогою:

```
firewall-cmd --reload
```

А потім укажіть зону, щоб ви могли бачити все за допомогою `firewall-cmd --zone=trusted --list-all`, що має дати вам щось на зразок цього:

```bash
trusted (active)
  target: ACCEPT
  icmp-block-inversion: no
  interfaces:
  sources: 192.168.1.0/24
  services: ssh
  ports:
  protocols:
  forward: no
  masquerade: no
  forward-ports:
  source-ports:
  icmp-blocks:
  rich rules:

```

Далі нам потрібно внести зміни в «публічну» зону, у якій за замовчуванням увімкнено службу `ssh`. Це потрібно обережно видалити (знову ж таки, ми припускаємо, що ви **НЕ** тут віддалені від сервера!) за допомогою наступного:

```
firewall-cmd --zone=public --remove-service=ssh --permanent
```
Нам також потрібно додати служби `http` і `https`:

```
firewall-cmd --zone=public --add-service=http --add-service=https --permanent
```

Тоді нам потрібно перезавантажити брандмауер, перш ніж ви побачите зміни:

```
firewall-cmd --reload
```

А потім перерахуйте загальнодоступну зону за допомогою `firewall-cmd --zone=public --list-all`, яка має показати вам щось на зразок цього:

```bash
public
  target: default
  icmp-block-inversion: no
  interfaces:
  sources:
  services: cockpit dhcpv6-client http https
  ports:
  protocols:
  forward: no
  masquerade: no
  forward-ports:
  source-ports:
  icmp-blocks:
  rich rules:
```

Це єдині зміни, які нам потрібно внести в балансувальник навантаження сервера pound у нашому лабораторному середовищі.

### Брандмауер - внутрішні сервери

Для серверів "BackEnd" нам не потрібно дозволяти доступ із світу для будь-чого, а не для наших портів прослуховування, які використовуватиме балансувальник навантаження. Нам потрібно буде дозволити `ssh` з IP-адрес локальної мережі та `http` і `https` з нашого балансувальника навантаження.

Це майже все.

Знову ж таки, ми збираємося додати службу `ssh` до нашої «довіреної» зони з тими самими командами, які ми використовували для нашого pound-сервера. Потім ми додамо зону під назвою «баланс», яку будемо використовувати для решти `http` і `https`, і встановимо вихідні IP-адреси балансувальника навантаження. Тобі вже весело?

Щоб бути швидким, давайте використаємо всі ті команди, які ми використовували для «довіреної» зони, в одному наборі команд:

```
firewall-cmd --zone=trusted --add-source=192.168.1.0/24 --permanent
firewall-cmd --zone=trusted --add-service=ssh --permanent
firewall-cmd --reload
firewall-cmd --zone=trusted --list-all
```

Після цього «довірена» зона повинна виглядати так:

```bash
trusted (active)
  target: ACCEPT
  icmp-block-inversion: no
  interfaces:
  sources: 192.168.1.0/24
  services: ssh
  ports:
  protocols:
  forward: no
  masquerade: no
  forward-ports:
  source-ports:
  icmp-blocks:
  rich rules:
```

Ще раз перевірте своє правило `ssh` з IP-адреси в локальній мережі, а потім видаліть службу `ssh` із «публічної» зони. **Пам’ятайте наше попередження вище та робіть це, лише якщо у вас є локальний доступ до сервера!**

```
firewall-cmd --zone=public --remove-service=ssh --permanent
firewall-cmd --reload
firewall-cmd --zone=public --list-all
```

Тепер публічна зона має виглядати так:

```bash
public
  target: default
  icmp-block-inversion: no
  interfaces:
  sources:
  services: cockpit dhcpv6-client
  ports:
  protocols:
  forward: no
  masquerade: no
  forward-ports:
  source-ports:
  icmp-blocks:
  rich rules:
```

Тепер давайте додамо цю нову зону для роботи з `http` і `https`. Пам’ятайте, що IP джерела тут має бути лише нашим балансувальником навантаження (у нашому прикладі: 192.168.1.103):

!!! note "Примітка"

    Нова зона має бути додана з опцією `--permanent` і не може бути використана до перезавантаження брандмауера. Крім того, не забудьте `--set-target=ACCEPT` для цієї зони!

```
firewall-cmd --new-zone=balance --permanent
firewall-cmd --reload
firewall-cmd --zone=balance --set-target=ACCEPT
firewall-cmd --zone=balance --add-source=192.168.1.103 --permanent
firewall-cmd --zone=balance --add-service=http --add-service=https --permanent
firewall-cmd --reload
firewall-cmd --zone=balance --list-all
```

Результат:

```bash
balance (active)
  target: ACCEPT
  icmp-block-inversion: no
  interfaces:
  sources: 192.168.1.103
  services: http https
  ports:
  protocols:
  forward: no
  masquerade: no
  forward-ports:
  source-ports:
  icmp-blocks:
  rich rules:
```

Тепер повторіть ці кроки на сервері іншого веб-сервера.

Після того, як до всього додано правила брандмауера, знову перевірте свій pound-сервер у браузері робочої станції.

## Інша інформація

Є *БАГАТО* параметрів, які можна включити у ваш файл `pound.conf`, включаючи директиви повідомлень про помилки, параметри журналювання, значення часу очікування і т.д. Ви можете дізнатися більше про те, що доступно, [переглянувши тут.](https://linux.die.net/man/8/pound)

Зручно, Pound автоматично визначає, якщо один із «BackEnd» серверів офлайн, і вимикає його, щоб веб-сервіси могли продовжувати працювати без затримки. Він також автоматично бачить їх знову, коли вони знову в мережі.

## Висновок

Pound пропонує інший варіант для тих, хто не хоче використовувати HAProxy або Nginx для балансування навантаження.

Pound, сервер балансування навантаження, дуже простий у встановленні, налаштуванні та використанні. Як зазначено тут, Pound також можна використовувати як зворотний проксі, і доступно багато варіантів проксі та балансування навантаження.

І було б найкраще, якби ви ніколи не забували пам’ятати про безпеку під час налаштування будь-якої служби, включаючи проксі-сервер з балансуванням навантаження.
